---
title: "ROI study 2024 updated with new employers"
output:
  html_document:
    toc: yes
    toc_float: yes
    number_sections: yes
    code_folding: hide
    theme: lumen
  word_document:
    toc: yes
  pdf_document:
    toc: yes
---


```{r setup, include = F}
knitr::opts_chunk$set(echo = TRUE, 
               warning = FALSE,
               message = FALSE,
               fig.path='figures/',
               fig.width = 7, 
               fig.height = 5)
options(DT.options = list(pageLength = 100, language = list(search = 'Filter:')))

knitr::opts_knit$set(root.dir = '~/Library/CloudStorage/GoogleDrive-mhawrilenko@springhealth.com/Shared drives/Data Science/people/matt/ds_git/ds_research_roi_study_2023/code')
```


```{r load-packages, message = FALSE, results = 'hide'}
# load packages
library(knitr)
library(tidyverse)
library(nerdify)
library(janitor)
library(rio)
library(lubridate)
library(table1)
library(survey)
library(lme4)
library(lmerTest)
library(lmeresampler)
library(splines)
library(nnet)
library(foreach)
library(doParallel)
library(car)
library(sjPlot)
library(ggplot2)
library(ggrepel)
library(cowplot)
library(marginaleffects)
library(see)
library(kableExtra)
library(gt)
```


# Load data and functions

## Claims data 
``` {r load-data}

# Customers included in the study
customer_name <- c("Wellstar", "Pepsi", "Hearst", "Docusign", "Tegna", "Western Governors University", "IDEXX")

# Make some lists to fill up
data_funnel <- list()
df_care_use <- list()
df_appts <- list()

# Get datasets that have not yet been concatenated
for (i in 1:length(customer_name)) {
# Load data
data_funnel[[i]] <- readRDS(paste0(Sys.getenv("claims_folder_path"), "data/round_2_analysis/", customer_name[i], "/", customer_name[i], "_data_funnel.Rdata")) %>%
  mutate(customer_name = customer_name[i]) 
df_care_use[[i]] <- readRDS(paste0(Sys.getenv("claims_folder_path"), "data/round_2_analysis/", customer_name[i], "/", customer_name[i], "_care_use.Rdata"))
df_appts[[i]] <- readRDS(paste0(Sys.getenv("claims_folder_path"), "data/round_2_analysis/", customer_name[i], "/", customer_name[i], "_appts_by_month.Rdata"))
}

# Now bind into a single df
data_funnel <- data_funnel %>% bind_rows()
df_care_use <- df_care_use %>% bind_rows()
df_appts <- df_appts %>% bind_rows()

# Now the dfs that have previously been concatenated
df_analyze_all <- readRDS(paste0(Sys.getenv("claims_folder_path"), "data/roi_study_2023/new employer update/df_analyze_all_new_employers.Rdata"))
df_matched_orig <- readRDS(paste0(Sys.getenv("claims_folder_path"), "data/roi_study_2023/new employer update/df_matched_new_employers.Rdata"))

```


## Billing data
``` {r billing-data}

# direct bill

## all direct bill appts
billing_appts <- readRDS('~/Library/CloudStorage/GoogleDrive-mhawrilenko@springhealth.com/Shared drives/ROI - Direct bill/HEOR clean/billing data.Rdata')

# Loop stuff
spring_fees <- list()
prop_matched <- vector()
for (i in 1:length(customer_name)) {
  
  ## Get covered life IDs for members in the study
spring_match_to_elig <- import(paste0(Sys.getenv("claims_folder_path"), "data/", customer_name[i], "/data_to_sba/", customer_name[i], "_", "eligibility_cls.csv")) %>%
  rename(any_of(c(
    carrier_member_id = "member_key",
    carrier_member_id = "indv_id",
    carrier_member_id = "individual_id"
  ))) %>%
  mutate(carrier_member_id = as.character(carrier_member_id)) %>%
  select(carrier_member_id, covered_life_id)


## Need members in the study
study_members <- df_matched_orig %>%
  distinct(carrier_member_id, spring_dummy) %>%
  left_join(spring_match_to_elig)


## Match study members to their appts
apps_query <- "SELECT appointment_id, covered_life_id 
               FROM base_appointments 
               WHERE UPPER(customer_name) like ?"


apps <- dbGetQuery(con = snowflake_conn("base_layer"), apps_query, params = list(paste0('%', str_to_upper(customer_name[i]), '%'))) %>%
  clean_names()


## Calculate direct bill amounts by group
spring_start_date <- df_matched_orig %>%
  ungroup() %>%
  filter(str_like(customer_name, paste0('%', .env$customer_name[i], '%'), ignore_case = TRUE)) %>%
  distinct(spring_start_date) %>%
  pull(spring_start_date) 

spring_end_date <- df_matched_orig %>%
  ungroup() %>%
  filter(str_like(customer_name, paste0('%', .env$customer_name[i], '%'), ignore_case = TRUE)) %>%
  distinct(spring_end_date) %>%
  pull(spring_end_date) 

direct_bill <- billing_appts %>%
  filter(str_like(customer_name, paste0('%', .env$customer_name[i], '%'), ignore_case = TRUE)) %>% #.env$customer_name
  filter(month_of_service <= spring_end_date) %>%
  left_join(apps) %>% # get covered life id
  inner_join(study_members) %>% # only individuals included in the study
  ## sometimes an individual has multiple carrier member IDs. DOn't want duplicate billing. 
  ## so group by appointment_id and take first carrier_member_id
  group_by(appointment_id) %>% 
  filter(carrier_member_id == first(carrier_member_id) | is.na(carrier_member_id)) %>% # address billing data that gets duped
  ungroup() %>%
  summarize(amount = sum(total_billed, na.rm=T)) %>%
  pull(amount)


billing_all <- import(paste0(Sys.getenv("claims_folder_path"), "data/", customer_name[i], "/", customer_name[i], "_", "billing.xlsx")) %>%
  clean_names()

bundle_fee <- billing_all %>%
  filter(str_like(account, paste0('%', "bundle", '%'), ignore_case = TRUE)) %>%
  summarize(bundle_fee = sum(amount, na.rm=T)) %>%
  pull(bundle_fee)

platform_fee <- billing_all %>%
  filter(str_like(account, paste0('%', "platform", '%'), ignore_case = TRUE)) %>%
  summarize(platform_fee = sum(amount, na.rm=T)) %>%
  pull(platform_fee)

billed_to_health_plan <- readRDS(paste0(Sys.getenv("claims_folder_path"), "data/roi_at_scale/", customer_name[i], "/", customer_name[i], "_spring_med_claims.Rdata")) %>%
  filter(month_year <= spring_end_date) %>%
  mutate(carrier_member_id = as.character(carrier_member_id)) %>%
  inner_join(study_members) %>%
  ungroup() %>%
  summarize(billed_to_health_plan = sum(allowed_amt, na.rm=T)) %>%
  pull(billed_to_health_plan)


## Get number of eligible employees on the health plan in the date range
elig <- readRDS(file = paste0(Sys.getenv("claims_folder_path"), "/data/roi_at_scale/", customer_name[i], "/", customer_name[i], "_carrier_elig.Rdata")) %>%
  filter(month_year >= spring_start_date) %>%
  filter(month_year <= spring_end_date) %>%
  filter(employee_flag == "yes") 

## Get total employees
qry <- "SELECT DISTINCT a.customer_name, a.customer_id, id, dependent, b.created_at
                  FROM ds_trunk.base_layer.base_customers AS a
                  LEFT JOIN stitch_new.rotom_prod_replica.covered_lives AS b
                  ON a.customer_id = b.customer_id
                  WHERE UPPER(a.customer_name) LIKE ?
                  AND dependent = 'FALSE'
                  AND DATE(b.created_at) <= date(?)"

cl <- dbGetQuery(con = snowflake_conn("rotom"), qry, params = list(paste0('%', str_to_upper(customer_name[i]), '%'), spring_end_date)) %>%
  clean_names()

prop_on_health_plan <- n_distinct(elig$carrier_member_id) / n_distinct(cl$id)

cust_funnel <- data_funnel %>%
  filter(customer_name == .env$customer_name[i]) 
prop_matched <- pull(cust_funnel[7,4] / cust_funnel[1,4])

# Compile all fees
spring_fees[[i]] <- data.frame(
  fee_type = c("Bundle", "Platform", "Direct bill", "Billed to Health Plan")
) %>%
  mutate(
    customer_name = customer_name[i],
    prop_on_health_plan = prop_on_health_plan,
    prop_matched = prop_matched,
    Amount = case_when(
      fee_type == "Bundle" ~ bundle_fee * prop_on_health_plan * prop_matched,
      fee_type == "Platform" ~ platform_fee * prop_on_health_plan * prop_matched,
      fee_type == "Direct bill" ~ direct_bill,
      fee_type == "Billed to Health Plan" ~ billed_to_health_plan
    )
)
}
spring_fees <- spring_fees %>% bind_rows()

spring_fees %>%
  group_by(customer_name) %>%
  summarize(amount = sum(Amount, na.rm=T)) 

total_invoiced <- spring_fees %>%
  summarize(amount = sum(Amount, na.rm=T)) %>%
  pull(amount)

# Get monthly Spring costs
member_months <- df_matched_orig %>% ungroup() %>% filter(spring_dummy == "Spring", months_post>=1) %>% summarize(n=n()) %>% pull()
spring_pmpm_adjustment <- total_invoiced/member_months
effective_session_fee <- sum(spring_fees$Amount) / sum(df_matched_orig$spring_tx_count_month, na.rm = T)

```


# Analyze utilization pre and post launch
Spring promises to drive value by getting more people into care who otherwise would never have received it. Here, we test this premise by determining how much mental health treatment utilization changed after Spring launched. Here, we examine 3 metrics:  
  1. How annual outpatient behavioral health treatment utilization changed pre and post Spring  
  2. Any utilization by month  
  3. Number of sessions per month 
  


## Monthly utilization

``` {r monthly-utilization, fig.width = 10, fig.height = 5}

# Monthly utilization
plot_monthly_avg <- df_care_use %>%
  filter(month_year >= baseline_start_date) %>%
  filter(month_year <= spring_end_date) %>%
  mutate(
    months_std = case_when(
      month_year < spring_start_date ~ interval(spring_start_date, month_year) %/% months(1),
      month_year >= spring_start_date ~ interval(spring_start_date, month_year) %/% months(1) + 1
    ),
    phase = ifelse(month_year < spring_start_date, "Pre-launch", "Post-launch"),
    provider = "Spring"
    ) %>%
  # We need weights per employer per month
  group_by(customer_name, months_std) %>%
  mutate(employer_n = sum(!is.na(mh_appt_group))) %>%
  mutate(employer_weight = 1 / employer_n) %>% # employer weight by month
  group_by(mh_appt_group, months_std) %>%
  summarize(group_weight = sum(employer_weight)) %>%
  group_by(months_std) %>%
  mutate(mh_appt_in_month_proportion = group_weight / sum(group_weight)) %>%
  mutate(
    mh_appt_group = case_when(
      mh_appt_group == "Carrier only" ~ "Health Plan only",
      mh_appt_group == "Both Spring and Carrier" ~ "Both Program and Health Plan",
      mh_appt_group == "Spring only" ~ "Program only",
      TRUE ~ mh_appt_group)
    ) %>%
  mutate(mh_appt_group = factor(mh_appt_group, levels = c("Program only", "Both Program and Health Plan", "Health Plan only"))) %>%
  filter(mh_appt_group != "No appointments") %>%
  arrange(mh_appt_group, months_std)


## Plot

## Make some plotting locations
pre_mean_avg <- round(
  sum(plot_monthly_avg$mh_appt_in_month_proportion[plot_monthly_avg$months_std < 0])/12, 
  3)
post_mean_avg <- round(
  sum(plot_monthly_avg$mh_appt_in_month_proportion[plot_monthly_avg$months_std > 0])/12,
  3)
max_avg <-max(
  plot_monthly_avg %>%
    group_by(months_std) %>%
    summarize(apps_in_month = sum(mh_appt_in_month_proportion)) %>%
    pull(apps_in_month)
)

## Plot
color_scheme <- c("#37837c","#A9DbD6", '#c7c7c7') # set colors

p1 <- ggplot(plot_monthly_avg, aes(x = months_std, y=mh_appt_in_month_proportion, group = mh_appt_group, fill = mh_appt_group)) +
  geom_bar(position="stack", stat="identity") +
  scale_fill_manual(values = color_scheme, name = "Provider") +
  theme_modern() +
  geom_hline(yintercept = pre_mean_avg, linetype = "dashed") +
  geom_vline(xintercept = 0, color = "#48ADA3", linetype = "dashed") +
  theme(axis.text.x = element_text(angle = 70, vjust = 1, hjust=1)) +
  annotate(geom = "text", x = 3, y = max_avg*1.4, label = "Program launch", color = "#37837c", fontface = "bold", size = 4) +
  annotate(geom = "text", x = -6.5, y = pre_mean_avg*1.2, label = paste0("Pre-launch = ", 100*pre_mean_avg, "% per month"), color = "#767676", size = 4) +
  annotate(geom = "text", x = 6.5, y = post_mean_avg*1.2, label = paste0("Post-launch = ", 100*post_mean_avg, "% per month"), color = "#37837c", size = 4) +
  labs(
    title = "Monthly",
    x = "Months from Program launch",
    y = "Proportion"
  )
p1
```


## Annual utilization

``` {r summarize-utilization-data}

# Summarize to month level
df_phase_summary <- df_care_use %>%
  filter(month_year >= baseline_start_date) %>%
  filter(month_year <= spring_end_date) %>%
  mutate(phase = ifelse(month_year < spring_start_date, "Pre-launch", "Post-launch")) %>%
  mutate(phase = factor(phase, levels = c("Pre-launch", "Post-launch"))) %>%
  group_by(customer_name, carrier_member_id, phase) %>%
  summarize(
    carrier_tx_count_month = sum(carrier_tx_count_month),
    spring_tx_count_month = sum(spring_tx_count_month),
    carrier_therapist_count_month = sum(carrier_therapist_count_month),
    spring_therapist_count_month = sum(spring_therapist_count_month)
  ) %>%
  ungroup() %>%
  mutate(
    mh_appt_group = factor(case_when(
      carrier_tx_count_month > 0 & spring_tx_count_month > 0 ~ "Both Program and Health Plan",
      carrier_tx_count_month > 0 & spring_tx_count_month == 0 ~ "Health Plan only",
      carrier_tx_count_month == 0 & spring_tx_count_month > 0 ~ "Program only",
      carrier_tx_count_month == 0 & spring_tx_count_month == 0 ~ "No appointments"
    ),
    levels = c("Program only", "Both Program and Health Plan", "Health Plan only", "No appointments")
    ))

## Add weights
df_phase_summary <- df_phase_summary %>%
  mutate(any_utilization = ifelse(mh_appt_group == "No appointments", "no", "yes")) %>%
  mutate(any_utilization = as.factor(any_utilization)) %>%
  # make weights
  group_by(customer_name, phase) %>%
  mutate(employer_n = sum(!is.na(any_utilization))) %>%
  mutate(employer_weight = 1 / employer_n) %>%
  mutate(customer_name = as.factor(customer_name)) %>%
  ungroup()
```


## Customer-average
``` {r cust-avg-utilization, fig.width = 9, fig.height = 9}

## Model

## Make survey design object with members nested in customers
d1 <- svydesign(
  id = ~ customer_name + carrier_member_id, # members nested in customers. Order matters in this equation.
  weights = ~employer_weight, 
  data = df_phase_summary) 

## Model
m1 <- svyglm(any_utilization ~ phase, family = binomial, design = d1)

## Point estimates
month_estimates <- predictions(m1, newdata = df_phase_summary %>% distinct(phase), type = "response") %>%
  arrange(phase) %>%
  data.frame() %>%
  mutate(
    mh_appt_group = "Program only",
    percent = 100 * estimate,
    percent.low = 100 * conf.low,
    percent.high = 100 * conf.high
    )
month_estimates
## Test pre-post difference
hypotheses(m1, hypothesis = "exp(b1 + b2) / (1 + exp(b1 + b2)) - exp(b1) / (1 + exp(b1)) = 0")


# Plot weighted data
care_use_avg <- df_phase_summary %>%
  group_by(customer_name, phase) %>%
  mutate(employer_n = sum(!is.na(mh_appt_group))) %>%
  mutate(employer_weight = 1 / employer_n) %>% # employer weight by month
  group_by(phase, mh_appt_group) %>%
  summarize(group_weight = sum(employer_weight)) %>%
  group_by(phase) %>%
  mutate(proportion = group_weight / sum(group_weight)) %>%
  filter(mh_appt_group != "No appointments") %>%
  arrange(mh_appt_group, phase) %>%
  mutate(percent = 100 * round(proportion, 3))
  

## plot
color_scheme <- c("#37837c","#A9DbD6", '#c7c7c7') # set colors

p2 <- ggplot(care_use_avg, aes(x = phase, y=percent, group = mh_appt_group, fill = mh_appt_group)) +
  geom_bar(position="stack", stat="identity", width = 0.5) +
  scale_fill_manual(values = color_scheme, name = "Provider") +
  geom_text(aes(label=percent), position = position_stack(vjust = 0.5), colour = "black") +
  geom_errorbar(data = month_estimates, aes(ymin = percent.low, ymax = percent.high, width = 0.1), color = "grey65", show.legend = F) +
  annotate(geom = "segment", x = 1.1, xend = 1.1, y = 12.6, yend = 13) +
  annotate(geom = "segment", x = 1.9, xend = 1.9, y = 12.6, yend = 13) +
  annotate(geom = "segment", x = 1.1, xend = 1.9, y = 13, yend = 13) +
  annotate(geom = "text", x = 1.4, y = 14.3, label = "difference = 3.9% [2.8% to 5.1%]\np < .001", hjust = 0.5, size=3.75) +
  theme_modern() +
  labs(
    title = "Annual",
    x = "",
    y = "Percent",
    group = "",
    fill = ""
  )
p2
```


## Figure 1: Utilization

``` {r plot-figure-1, fig.width = 9, fig.height = 9}
plot_grid(
  p1 + theme(legend.position = "none") + labs(title = ""),
  p2 + labs(title = ""),
  nrow=2,
  labels = c("A) Monthly utilization", "B) Annual utilization"),
  scale = .9
)

```




# Cohort comparisons
To determine Spring's impact on `r customer_name`'s total cost of care, we conducted a matching study. We identified the group of people who engaged with a Spring provider, a risk-matched group that did not use Spring, and compared the spend of both groups. Research demonstrates that spend increases at the time of a mental health diagnosis, so we compared changes in each group's spending from the year prior to receiving a MH diagnosis to the year after receiving a diagnosis, using a difference-in-differences design. 
  
  
## Data funnel
This table shows each step where participants were funneled into the analytic sample.
```{r data-funnel}


match_funnel <- df_matched_orig %>% 
  group_by(spring_dummy) %>%
  summarize(
    n = n_distinct(customer_name, carrier_member_id),
    filter_name = "Maintained in matching study"
    ) %>%
  mutate(total_n = sum(n)) %>%
  pivot_wider(
    id_cols = c(filter_name, total_n),
    names_from = spring_dummy,
    values_from = n
  ) 

# Fix different filter names
data_funnel <- data_funnel %>%
  mutate(filter_name = str_replace(filter_name, "No previous mental health diagnosis within", "No previous mental health treatment within"))

# Print
data_funnel %>%
  group_by(filter_name) %>%
  summarize(across(-customer_name, sum)) %>%
  rbind(match_funnel) %>%
  arrange(-total_n) %>%
  kbl(caption = "Participant funnel through inclusion criteria") %>%
  kable_classic(full_width = T, html_font = "Cambria") 
```


## Summarize unmatched data
Prior to conducting matching, we examined key risk characteristics of the pool of potential study participants. From this table, we can see that prior to match, the Spring group consisted of slightly more women, more individuals in the 25-44 age category, had slightly lower medical spending risk scores, and comparatively more mood and anxiety diagnoses and fewer substance use diagnoses.

``` {r summary}
df_unmatched_table <- df_analyze_all %>%
  filter(index_date >= spring_start_date) %>%
  group_by(carrier_member_id, spring_dummy, age_at_index, member_sex, cc_any, cc_asthma_copd, cc_diabetes, cc_hypertension, cc_heart, cc_stroke, cc_kidney, cc_osteo, cc_cancer) %>%
  arrange(month_year) %>%
  summarize(
    carrier_mh_dx = first(carrier_primary_mh_dx, na_rm = TRUE),
    spring_mh_dx = first(spring_primary_mh_dx, na_rm = TRUE),
    risk_score_dx = risk_score[months == 1]
  ) %>%
  ungroup() %>%
  mutate(mh_dx = coalesce(spring_mh_dx, carrier_mh_dx)) %>%
  mutate(dx_collapsed = fct_collapse(mh_dx,
                                   mood = "mood",
                                   anxiety = "anxiety",
                                   sud = "sud",
                                   other = c("personality", "psychotic", "intellectual disability", "physical behavioral", "physiological", "developmental", "child onset", "unspecified")
  )) %>%
  select(-c(carrier_mh_dx, spring_mh_dx)) %>%
  ungroup()

## Examine overall table
### NOTE: p-value function is broken so currently dropping
table1( ~ age_at_index + member_sex + mh_dx + dx_collapsed + risk_score_dx + cc_any + cc_asthma_copd + cc_diabetes + cc_hypertension + cc_heart
        + cc_stroke + cc_kidney + cc_osteo + cc_cancer | spring_dummy,
        overall = F,
        render.missing = NULL,
       render.categorical = "FREQ (PCTnoNA%)",
        data=df_unmatched_table)
```

  
  
  
## Table 1: Participant characteristics for matched groups
We matched on age, sex, mental health diagnosis, and medical spending risk scores (Department of Health and Human Services - Hierarchal Condition Categories - platinum tier). We matched on a ratio to include as many relevant participants from the comparison condition as possible. In total, we matched X spring participants to Y participants in the comparison group. After matching, the groups were essentially identical across all key characteristics. 

``` {r compare-match-groups}
df_match_table <- df_matched_orig %>%
  group_by(carrier_member_id) %>%
  arrange(months) %>%
  mutate(
    therapy_sessions_cum = case_when(
      spring_dummy == "Spring" ~ cumsum(spring_therapist_count_month),
      spring_dummy == "Health Plan" ~ cumsum(carrier_therapist_count_month)
    ),
    therapy_sessions_total = sum(spring_therapist_count_month, carrier_therapist_count_month, na.rm=T),
    session_count_total = sum(spring_tx_count_month, carrier_tx_count_month, na.rm=T),
    months_diagnosed = interval(index_date, spring_end_date) %/% months(1) + 1,
    cc_any2 = case_when(
      cc_cancer == "yes" ~ "yes",
      cc_hypertension == "yes" ~ "yes",
      cc_diabetes == "yes" ~ "yes",
      excl_pregnancy == "yes" ~ "yes",
      cc_asthma_copd == "yes" ~ "yes",
      TRUE ~ "no"
    )
  ) %>%
  mutate(
    any_bh = ifelse(session_count_total > 0, "yes", "no"),
    bh_if_engaged = ifelse(session_count_total > 0, session_count_total, NA),
    therapy_if_engaged = ifelse(therapy_sessions_total > 0, therapy_sessions_total, NA)
    ) %>%
  group_by(carrier_member_id, cc_any2, cc_asthma_copd, cc_diabetes, cc_hypertension, cc_cancer, excl_pregnancy) %>%
  arrange(months) %>%
  slice_head() %>%
  ungroup() %>%
  mutate(spring_dummy = factor(spring_dummy, labels = c("Control", "Spring Health"))) 


# Weighted Table 1
library(survey)
library(tableone)
t1_design <- svydesign(ids = ~carrier_member_id, strata = ~spring_dummy, weights = ~weights_nn,
                       nest = TRUE, data = df_match_table)

t1 <- svyCreateTableOne(
  vars = c("age_at_index", "member_sex", "dx_imputed", "risk_score_dx", "months_diagnosed",
           "cc_asthma_copd", "cc_diabetes", "cc_hypertension", "cc_cancer", "excl_pregnancy",  "any_bh", "bh_if_engaged"), 
  strata = "spring_dummy", 
  data = t1_design) 

# Make adjusted p-values
print(t1, pDigits=10, catDigits=1, contDigits=2) %>% 
  data.frame() %>%
  rownames_to_column(var = "Characteristic") %>%
  
  # Format for kbl table
  mutate(
    p = ifelse(p == "<0.0000000001", .0000000001, p),
    adj_p = p.adjust(p, method = "BH"),
    adj_p = ifelse(adj_p >= .06, round(adj_p, 2), round(adj_p, 3)),
    adj_p = ifelse(adj_p < .001, "< 0.001", adj_p),
    adj_p = ifelse(adj_p > .999, " > 0.999", adj_p)
  ) %>%
  rename(Program = Spring.Health) %>%
  mutate(across(everything(), ~ifelse(is.na(.), "", .))) %>%
  kableone() %>%
  kable_classic(full_width = FALSE, html_font = "Cambria") %>%
  remove_column(c(4, 5))
```

  

# Medical spending outcomes
## Models
Below are the results of the total cost of care study across the entire population and the matched group only.
``` {r net-spend, fig.width = 9, fig.height = 5}

# Add net
df_matched <- df_matched_orig %>%
  
  # Convert paid to allowed
  mutate(across(c(med_pmpm, 
                  med_pmpm_trunc, 
                  med_pmpm_trunc_therapy_mh, 
                  med_pmpm_trunc_ov_mh, 
                  med_pmpm_trunc_er_mh, 
                  med_pmpm_trunc_ip_mh,
                  med_pmpm_trunc_hosp_op_mh,
                  med_pmpm_trunc_other_mh,
                  med_pmpm_trunc_therapy_nonmh,
                  med_pmpm_trunc_ov_nonmh,
                  med_pmpm_trunc_er_nonmh, 
                  med_pmpm_trunc_ip_nonmh, 
                  med_pmpm_trunc_hosp_op_nonmh,
                  med_pmpm_trunc_other_nonmh),
                ~ifelse(customer_name == "Hearst" | customer_name == "Western Governors University", .x/.8, .x)
  )) %>%
  #Add net
  mutate(
    med_pmpm_net = med_pmpm + effective_session_fee * spring_tx_count_month,
    med_pmpm_trunc_net = med_pmpm_trunc + effective_session_fee * spring_tx_count_month,
    med_pmpm_therapy_mh_net = med_pmpm_therapy_mh + effective_session_fee * spring_tx_count_month,
    med_pmpm_trunc_therapy_mh_net = med_pmpm_trunc_therapy_mh + effective_session_fee * spring_tx_count_month
  )

# Aggregate to mental and physical health spend
df_matched <- df_matched %>%
  mutate(
    med_pmpm_trunc_mh_net = 
      med_pmpm_trunc_therapy_mh_net + 
      med_pmpm_trunc_ov_mh + 
      med_pmpm_trunc_er_mh + 
      med_pmpm_trunc_ip_mh + 
      med_pmpm_trunc_hosp_op_mh + 
      med_pmpm_trunc_other_mh,
    med_pmpm_trunc_nonmh = 
      med_pmpm_trunc_therapy_nonmh + 
      med_pmpm_trunc_ov_nonmh + 
      med_pmpm_trunc_er_nonmh + 
      med_pmpm_trunc_ip_nonmh + 
      med_pmpm_trunc_hosp_op_nonmh + 
      med_pmpm_trunc_other_nonmh
  )

## Let's recode customer so the intercept reflects the average across participants
#cust_recode <- df_matched %>%
#  group_by(customer_name) %>%
#  summarize(cust_row_count = n()) %>%
#  ungroup() %>%
#  mutate(cust_prop = cust_row_count/sum(cust_row_count)) %>%
#  select(customer_name, cust_prop) %>%
#  pivot_wider(names_from = customer_name, values_from = cust_prop) 


## Model
m1_gross_unmatched <- lmer(med_pmpm_trunc ~ 1 + spring_dummy + spring_dummy*phase + 
             (1 | carrier_member_id),
           #weights = weights_nn,
           data = df_analyze_all)

m1_gross <- lmer(med_pmpm_trunc ~ 1 + spring_dummy + spring_dummy*phase + 
             (1 | carrier_member_id) +
             (1 | subclass_nn),
           weights = weights_nn,
           data = df_matched)

m1_net <- lmer(med_pmpm_trunc_net ~ 1 + spring_dummy + spring_dummy*phase + 
             (1 | carrier_member_id) +
             (1 | subclass_nn),
           weights = weights_nn,
           data = df_matched)

tab_model(m1_net,
          pred.labels = c("Baseline PMPM", "Baseline difference (Spring - Control)", "Control pre-post change", "Diff-in-diff (Spring change - Control change)"),
          title = "Net medical spending")

# Sensitivity
tab_model(m1_gross_unmatched, m1_gross, m1_net, 
          show.ci=F, 
          show.se=T, 
          pred.labels = c("Baseline PMPM", "Baseline difference (Spring - Control)", "Control pre-post change", "Diff-in-diff (Spring change - Control change)"),
          dv.labels = c("No matching - Gross spending", "Matched group spending - Gross", "Total Spend - Net",
          title = "Sensitivity analysis - Medical spending"))
```


## Table 2: Medical spending outcomes with bootstrap standard errors
``` {r bootstrap}
 # set.seed(8102018)
 # nboot <- 5000
 # ncores <- 5
 # 
 # cl <- makeCluster(ncores, type = "PSOCK") # make a socket cluster
 # doParallel::registerDoParallel(cl)          # how the CPU knows to run in parallel
 # 
 # # Run bootstrap
 # m1_boot <- foreach(B = rep(nboot/ncores, ncores), 
 #                        .combine = combine_lmeresamp,
 #                        .packages = c("lmeresampler", "lme4")) %dopar% {
 #                          bootstrap(m1_net, .f = fixef, type = "residual", B = B)
 #                        }
 # stopCluster(cl)
 # 
 # # Get CIs
 # confint(m1_boot, type = "perc") %>%
 #   select(term, estimate, lower, upper) %>%
 #   mutate(across(estimate:upper, ~round(.x, 2))) %>%
 #   kableone() %>%
 #   kable_classic(full_width = FALSE, html_font = "Cambria")
```


## Figure 2: Net medical spending
``` {r plot-med-spending-results, fig.width = 6, fig.height = 4}
df_plot <- df_matched %>%
  ungroup() %>%
  distinct(spring_dummy, phase) %>%
  mutate(
    phase_label = case_when(
      phase == "pre_tx" ~ "Before MH diagnosis",
      phase == "post_tx" ~ "After MH diagnosis"
    )
  ) %>%
  mutate(phase_label = factor(phase_label, levels = c("Before MH diagnosis", "After MH diagnosis")))

df_plot_total <- predictions(m1_net, newdata = df_plot, re.form = ~0)


# Overall with error bars
color_scheme <- c('#c7c7c7', "#37837c")

ggplot(df_plot_total, aes(x=phase_label, y=estimate, ymin=conf.low, ymax=conf.high, group = spring_dummy, color = spring_dummy)) +
  geom_errorbar(width = 0.05) +
  geom_point(size=3) +
  geom_line() +
  scale_color_manual(values = color_scheme, labels = c("Control", "Program")) +
  geom_text_repel(aes(label=round(estimate, 0)), hjust = ifelse(df_plot$phase_label == "Before MH diagnosis", 1.4, -0.4)) +
  theme_modern() +
  theme(legend.position = "bottom") +
  labs(
    title = "Spend trajectories for Program group versus matched control",
    x = "",
    y = "PMPM allowed amount",
    color = ""
  )


```
  
  
## Pharmacy spend models
``` {r model-rx-spend, fig.width = 9, fig.height = 5}

# Only run rx models if client has rx data
## No matching
m1_rx_no_match <- lmer(rx_pmpm_trunc ~ 1 + spring_dummy + spring_dummy*phase + customer_name +
             (1 | carrier_member_id),
           data = filter(df_analyze_all, index_date >= spring_start_date))

## Matching
m1_rx_yes_match <- lmer(rx_pmpm_trunc ~ 1 + spring_dummy + spring_dummy*phase + customer_name +
             (1 | carrier_member_id) +
             (1 | subclass_nn),
           weights = weights_nn,
           data = df_matched)

tab_model(m1_rx_no_match, m1_rx_yes_match, show.ci=F, show.se=T, 
          pred.labels = c("Baseline PMPM", "Baseline difference (Spring - Control)", "Control pre-post change", "Diff-in-diff (Spring change - Control change)"),
          dv.labels = c("Umatched", "Matched"),
          title = "Spring effect on gross pharmacy spending")

# Sensitivity: heavy truncation
df_matched <- df_matched %>%
  mutate(
     rx_pmpm_trunc10k = ifelse(rx_pmpm_trunc > 10000, 10000, rx_pmpm_trunc),
     rx_pmpm_trunc5k = ifelse(rx_pmpm_trunc > 5000, 5000, rx_pmpm_trunc),
     rx_pmpm_trunc2.5k = ifelse(rx_pmpm_trunc > 2500, 2500, rx_pmpm_trunc)
    )

m1_rx_truncate10k <- lmer(rx_pmpm_trunc10k ~ 1 + spring_dummy + spring_dummy*phase + customer_name +
             (1 | carrier_member_id) +
             (1 | subclass_nn),
           weights = weights_nn,
           data = df_matched)

m1_rx_truncate5k <- lmer(rx_pmpm_trunc5k ~ 1 + spring_dummy + spring_dummy*phase + customer_name +
             (1 | carrier_member_id) +
             (1 | subclass_nn),
           weights = weights_nn,
           data = df_matched)

m1_rx_truncate2.5k <- lmer(rx_pmpm_trunc2.5k ~ 1 + spring_dummy + spring_dummy*phase + customer_name +
             (1 | carrier_member_id) +
             (1 | subclass_nn),
           weights = weights_nn,
           data = df_matched)

tab_model(m1_rx_yes_match,
          show.ci=T, 
          show.se=T, 
          pred.labels = c("Baseline PMPM", "Baseline difference (Spring - Control)", "Control pre-post change", "Diff-in-diff (Spring change - Control change)"),
          title = "Spring effect on net pharmacy spending")


tab_model(m1_rx_yes_match, m1_rx_truncate10k, m1_rx_truncate5k, m1_rx_truncate2.5k, show.ci=F, show.se=T, 
          pred.labels = c("Baseline PMPM", "Baseline difference (Spring - Control)", "Control pre-post change", "Diff-in-diff (Spring change - Control change)"),
          dv.labels = c("Matched - Standard truncation", "Any baseline pharm spend", "Truncate 10k", "Truncate 5k", "Truncate 2.5k"),
          title = "Spring effect on gross pharmacy spending")

```


# Cost categories

## Table 3: Cost categories
``` {r cost-categories}
# Mental health vs Physical health
m1_mh <- lmer(med_pmpm_trunc_mh_net ~ 1 + spring_dummy + spring_dummy*phase + 
                (1 | carrier_member_id) +
                (1 | subclass_nn),
              weights = weights_nn,
              data = df_matched)

m1_nonmh <- lmer(med_pmpm_trunc_nonmh ~ 1 + spring_dummy + spring_dummy*phase + 
                   (1 | carrier_member_id) +
                   (1 | subclass_nn),
                 weights = weights_nn,
                 data = df_matched)

# By category

cc1 <- lmer(med_pmpm_trunc_ov_mh ~ 1 + spring_dummy + spring_dummy*phase +
              (1 | carrier_member_id) +
              (1 | subclass_nn),
            weights = weights_nn,
            data = df_matched)

cc2 <- lmer(med_pmpm_trunc_er_mh ~ 1 + spring_dummy + spring_dummy*phase +
              (1 | carrier_member_id) +
              (1 | subclass_nn),
            weights = weights_nn,
            data = df_matched)

cc3 <- lmer(med_pmpm_trunc_hosp_op_mh ~ 1 + spring_dummy + spring_dummy*phase +
              (1 | carrier_member_id) +
              (1 | subclass_nn),
            weights = weights_nn,
            data = df_matched)

cc4 <- lmer(med_pmpm_trunc_ip_mh ~ 1 + spring_dummy + spring_dummy*phase +
              (1 | carrier_member_id) +
              (1 | subclass_nn),
            weights = weights_nn,
            data = df_matched)

cc5 <- lmer(med_pmpm_trunc_therapy_mh_net ~ 1 + spring_dummy + spring_dummy*phase +
              (1 | carrier_member_id) +
              (1 | subclass_nn),
            weights = weights_nn,
            data = df_matched)

cc6 <- lmer(med_pmpm_trunc_other_mh ~ 1 + spring_dummy + spring_dummy*phase +
              (1 | carrier_member_id) +
              (1 | subclass_nn),
            weights = weights_nn,
            data = df_matched)

## Non-MH
cc7 <- lmer(med_pmpm_trunc_ov_nonmh ~ 1 + spring_dummy + spring_dummy*phase +
              (1 | carrier_member_id) +
              (1 | subclass_nn),
            weights = weights_nn,
            data = df_matched)

cc8 <- lmer(med_pmpm_trunc_er_nonmh ~ 1 + spring_dummy + spring_dummy*phase +
              (1 | carrier_member_id) +
              (1 | subclass_nn),
            weights = weights_nn,
            data = df_matched)

cc9 <- lmer(med_pmpm_trunc_hosp_op_nonmh ~ 1 + spring_dummy + spring_dummy*phase +
              (1 | carrier_member_id) +
              (1 | subclass_nn),
            weights = weights_nn,
            data = df_matched)

cc10 <- lmer(med_pmpm_trunc_ip_nonmh ~ 1 + spring_dummy + spring_dummy*phase +
              (1 | carrier_member_id) +
              (1 | subclass_nn),
            weights = weights_nn,
            data = df_matched)

cc11 <- lmer(med_pmpm_trunc_therapy_nonmh ~ 1 + spring_dummy + spring_dummy*phase +
              (1 | carrier_member_id) +
              (1 | subclass_nn),
            weights = weights_nn,
            data = df_matched)

cc12 <- lmer(med_pmpm_trunc_other_nonmh ~ 1 + spring_dummy + spring_dummy*phase +
              (1 | carrier_member_id) +
              (1 | subclass_nn),
            weights = weights_nn,
            data = df_matched)

spend_cat <- rep(c("Office visits", "Emergency room", "Hospital outpatient", "Hospital inpatient", "Behavioral Health", "Other"), 2)
mh_spend <- c(rep("Mental health", 6), rep("Physical health", 6))
df_cc_list <- list()
df_table_list <- list()

# Make plot data
for (i in 1:12) {
  df_temp <- predictions(get(paste0("cc", i)), newdata = df_plot, re.form = ~0) %>%
    mutate(
      spend_category = spend_cat[i],
      mh = mh_spend[i]
      )
  df_cc_list[[i]] <- df_temp
}

# Make table data
for (i in 1:12) {
  df_temp <- hypotheses(get(paste0("cc", i)), "b4 = 0") %>%
    mutate(
      spend_category = spend_cat[i],
      mh = mh_spend[i]
      )
  df_table_list[[i]] <- df_temp
}

df_total_spend <- rbind(
    hypotheses(m1_mh, "b4 = 0"),
    hypotheses(m1_nonmh, "b4 = 0")
    ) %>%
  data.frame(
    spend_category = c("Total mental health", "Total physical health"),
    mh = c("Mental health", "Physical health")
    )


df_table_cost_cat <- df_table_list %>% 
  bind_rows() %>%
  data.frame() %>%
  rbind(df_total_spend) %>%
  filter(!(spend_category == "Behavioral Health" & mh == "Physical health")) %>%
  select(mh, spend_category, estimate, conf.low, conf.high, p.value) %>%
  mutate(adj_p = p.adjust(p.value, method = "BH")) %>%
  mutate(adj_p = ifelse(adj_p < .001, "< 0.001", round(adj_p, 3))) %>%
  mutate(across(c(3:5), ~round(.x, 0))) %>%
  select(-p.value) %>%
  slice(1:6, 12, 7:11, 13) # get the rows in the correct order

df_table_cost_cat %>%
  kableone() %>%
  kable_classic(full_width = FALSE, html_font = "Cambria") %>%
  pack_rows(index = table(df_table_cost_cat$mh)) %>%
  remove_column(1)
```


## Figure 3: Cost categories
``` {r service-category-figures, fig.width = 12, fig.height = 9}
df_cc_plot <- df_cc_list %>%
  bind_rows() %>%
  filter(phase == "post_tx") %>%
  select(spring_dummy, spend_category, mh, estimate, conf.low, conf.high) %>%
  mutate(spring_dummy = factor(spring_dummy, levels = c("Health Plan", "Spring"))) %>%
  mutate(spend_category = factor(spend_category, levels = c("Office visits", "Emergency room", "Hospital outpatient", "Hospital inpatient", "Behavioral Health")))


# Aesthetics
y_total <- 700 # total axis scale
y_cat <- 275 # category axis scale
cc_colors <- c("#34a853", "grey")

# Overall MH
df_plot_mh <- predictions(m1_mh, newdata = df_plot, re.form = ~0) %>%
  mutate(spend_category = "Mental Health - Overall") %>%
  filter(phase == "post_tx") %>%
  mutate(spring_dummy = ifelse(spring_dummy == "Spring", "Program", "Control"))

p3 <- ggplot(df_plot_mh, aes(x=spring_dummy, y=estimate, ymin = conf.low, ymax = conf.high, fill = spring_dummy, group = spring_dummy)) +
  geom_bar(stat = "identity", width = 0.5) +
  geom_errorbar(width = .1, color = "gray45") +
  scale_fill_manual(values = rev(cc_colors), labels = c("Control", "Program")) +
  geom_text(aes(x=spring_dummy, y=conf.high, label = round(estimate, 0), fill = NULL), colour = "gray35", size = 4, vjust=-0.3) +
  scale_y_continuous(breaks = seq(0, y_total, by = 200), limits = c(0, y_total)) +
  theme_modern() +
  theme(panel.grid.major.y = element_line(color = "gray85")) +
  theme(axis.text.x = element_text(size=15)) +
  theme(axis.text.y = element_text(size=15)) +
  theme(axis.title.x = element_text(size=18)) +
  theme(legend.text =  element_text(size=14)) +
  theme(
    legend.position = "none",
    legend.justification = "right",
    strip.text = element_text(size=15)
  ) +
  labs(
    title = "Mental Health Costs - Overall",
    x = "",
    y = "PMPM spend",
    fill = " "
  )
fig_legend <- get_legend(p1 + theme(legend.position = "bottom"))

# Overall PH
df_plot_nonmh <- predictions(m1_nonmh, newdata = df_plot, re.form = ~0) %>%
  filter(phase == "post_tx") %>%
  mutate(spend_category = "Physical Health - Overall") %>%
  mutate(spring_dummy = ifelse(spring_dummy == "Spring", "Program", "Control"))

p4 <- ggplot(df_plot_nonmh, aes(x=spring_dummy, y=estimate, ymin = conf.low, ymax = conf.high, fill = spring_dummy, group = spring_dummy)) +
  geom_bar(stat = "identity", width = 0.5) +
  geom_errorbar(width = .1, color = "gray45") +
  scale_fill_manual(values = rev(cc_colors), labels = c("Control", "Program")) +
  geom_text(aes(x=spring_dummy, y=conf.high, label = round(estimate, 0), fill = NULL), colour = "gray35", size = 4, vjust=-0.3) +
  scale_y_continuous(breaks = seq(0, y_total, by = 200), limits = c(0, y_total)) +
  theme_modern() +
  theme(panel.grid.major.y = element_line(color = "gray85")) +
  theme(axis.text.x = element_text(size=15)) +
  theme(axis.text.y = element_text(size=15)) +
  theme(axis.title.x = element_text(size=18)) +
  theme(legend.text =  element_text(size=14)) +
  theme(
    legend.position = "none",
    legend.justification = "right",
    strip.text = element_text(size=15)
  ) +
  labs(
    title = "Physical Health Costs - Overall",
    x = "",
    y = "PMPM spend",
    fill = " "
  )


# MH breakdown
p5 <- ggplot(filter(df_cc_plot, mh == "Mental health"), aes(x=spend_category, y=estimate, ymin = conf.low, ymax = conf.high, fill = spring_dummy, group = spring_dummy)) +
  geom_bar(stat = "identity", width = 0.6, position = position_dodge()) +
  geom_errorbar(position = position_dodge(0.6), width = .1, color = "gray45") +
  scale_fill_manual(values = rev(cc_colors), labels = c("Control", "Program")) +
  geom_text(aes(x=spend_category, y=conf.high, label = round(estimate, 0), fill = NULL), colour = "gray35", size = 4, vjust=-0.3, position = position_dodge(width = 0.6)) +
  scale_x_discrete(labels = scales::label_wrap(10)) +
  scale_y_continuous(breaks = seq(0, y_cat, by = 100), limits = c(-20, 275)) +
  theme_modern() +
  theme(panel.grid.major.y = element_line(color = "gray85")) +
  theme(axis.text.x = element_text(size=15)) +
  theme(axis.text.y = element_text(size=15)) +
  theme(axis.title.x = element_text(size=18)) +
  theme(legend.text =  element_text(size=14)) +
  theme(
    legend.position = "none",
    legend.justification = "right",
    strip.text = element_text(size=15)
  ) +
  labs(
    title = "Mental Health Costs by Service Category",
    x = "",
    y = "PMPM spend",
    fill = " "
  )


# PH breakdown
p6 <- ggplot(filter(df_cc_plot, mh == "Physical health" & spend_category != "Behavioral Health"), aes(x=spend_category, y=estimate, ymin = conf.low, ymax = conf.high, fill = spring_dummy, group = spring_dummy)) +
  geom_bar(stat = "identity", width = 0.6, position = position_dodge()) +
  geom_errorbar(position = position_dodge(0.6), width = .1, color = "gray45") +
  scale_fill_manual(values = rev(cc_colors), labels = c("Control", "Program")) +
  geom_text(aes(x=spend_category, y=conf.high, label = round(estimate, 0), fill = NULL), colour = "gray35", size = 4, vjust=-0.3, position = position_dodge(width = 0.6)) +
  scale_x_discrete(labels = scales::label_wrap(10)) +
  scale_y_continuous(breaks = seq(0, y_cat, by = 100), limits = c(-20, 275)) +
  theme_modern() +
  theme(panel.grid.major.y = element_line(color = "gray85")) +
  theme(axis.text.x = element_text(size=15)) +
  theme(axis.text.y = element_text(size=15)) +
  theme(axis.title.x = element_text(size=18)) +
  theme(legend.text =  element_text(size=14)) +
  theme(
    legend.position = "none",
    legend.justification = "right",
    strip.text = element_text(size=15)
  ) +
  labs(
    title = "Physical Health Costs by Service Category",
    x = "",
    y = "PMPM spend",
    fill = " "
  )

cowplot::plot_grid(p3, p4, p5, p6, NA, fig_legend, nrow=3, rel_heights = c(1,1,.07))
```



# High cost conditions

## High cost conditions models
``` {r chronic-condition-modeling}

df_matched <- df_matched %>%
  mutate(cc_any = case_when(
    cc_any == "yes" ~ "yes",
    excl_pregnancy == "yes" ~ "yes",
    TRUE ~ cc_any
  ))


## Model
hcc1 <- lmer(med_pmpm_trunc_net ~ 1 + spring_dummy + spring_dummy*phase + 
             cc_any + cc_any*(spring_dummy + spring_dummy*phase) +
             customer_name +
             (1 | carrier_member_id) +
             (1 | subclass_nn),
           weights = weights_nn,
           data = filter(df_matched, cc_any == "no" | cc_diabetes == "yes"))

hcc2 <- lmer(med_pmpm_trunc_net ~ 1 + spring_dummy + spring_dummy*phase + 
             cc_any + cc_any*(spring_dummy + spring_dummy*phase) +
             customer_name +
             (1 | carrier_member_id) +
             (1 | subclass_nn),
           weights = weights_nn,
           data = filter(df_matched, cc_any == "no" | cc_hypertension == "yes"))

hcc3 <- lmer(med_pmpm_trunc_net ~ 1 + spring_dummy + spring_dummy*phase + 
             cc_any + cc_any*(spring_dummy + spring_dummy*phase) +
             customer_name +
             (1 | carrier_member_id) +
             (1 | subclass_nn),
           weights = weights_nn,
           data = filter(df_matched, cc_any == "no" | cc_asthma_copd == "yes"))

hcc4 <- lmer(med_pmpm_trunc_net ~ 1 + spring_dummy + spring_dummy*phase + 
             cc_any + cc_any*(spring_dummy + spring_dummy*phase) +
             customer_name +
             (1 | carrier_member_id) +
             (1 | subclass_nn),
           weights = weights_nn,
           data = filter(df_matched, cc_any == "no" | excl_pregnancy == "yes"))

hcc5 <- lmer(med_pmpm_trunc_net ~ 1 + spring_dummy + spring_dummy*phase + 
             cc_any + cc_any*(spring_dummy + spring_dummy*phase) +
             customer_name +
             (1 | carrier_member_id) +
             (1 | subclass_nn),
           weights = weights_nn,
           data = filter(df_matched, cc_any == "no" | cc_cancer == "yes"))

m_no_hcc <- lmer(med_pmpm_trunc_net ~ 1 + spring_dummy + spring_dummy*phase + 
             cc_any + cc_any*(spring_dummy + spring_dummy*phase) +
             customer_name +
             (1 | carrier_member_id) +
             (1 | subclass_nn),
           weights = weights_nn,
           data = df_matched)

tab_model(hcc1, hcc2, hcc3, hcc4, hcc5, m_no_hcc,
          dv.labels = c("Diabetes", "Hypertension", "Asthma/COPD", "Pregnancy", "Cancer", "Any HCC"),
          show.ci=F, 
          show.se=T)
```


## Table 4 and Figure 4: High cost condition difference in differences
``` {r plot-high-cost-conditions}

# Make plotting df
m_list <- list(hcc1, hcc2, hcc3, hcc4, hcc5)
df_cc_results <- data.frame(
  Term = NA, 
  Estimate = NA, 
  se = NA, 
  z = NA, 
  p = NA, 
  lb = NA, 
  ub = NA)

for (i in 1:length(m_list)) {
  df_cc_results[i,] <- hypotheses(m_list[[i]], hypothesis = "b11 + b14 = 0")
  df_cc_results[length(m_list) + 1,] <- hypotheses(m_no_hcc, hypothesis = "b11 = 0")
}

# Add cc names
df_cc_results <- df_cc_results %>%
  mutate(
    hcc = c("Diabetes", "Hypertension", "Asthma/COPD", "Pregnancy", "Cancer", "No high cost condition"),
    var_name = c("cc_diabetes", "cc_hypertension", "cc_asthma_copd", "excl_pregnancy", "cc_cancer", "No high cost condition")
  )

## Make it nice
df_plot_hcc <- df_cc_results %>%
  mutate(
    Estimate = -1*Estimate,
    upper = -1*lb,
    lower = -1*ub
  ) %>%
  mutate(hcc = fct_reorder(as.factor(hcc), Estimate))

# Make table
df_plot_hcc %>%
  mutate(adj_p = p.adjust(p, method = "BH")) %>%
  mutate(adj_p = ifelse(adj_p < .001, "< 0.001", round(adj_p, 3))) %>%
  select(hcc, Estimate, lower, upper, adj_p) %>%
  mutate(across(c(2:4), ~round(.x, 0))) %>%
  kableone() %>%
  kable_classic(full_width = FALSE, html_font = "Cambria") 

# Make dotplot
ggplot(df_plot_hcc, aes(x=Estimate, xmin=lower, xmax=upper, y=hcc)) +
  geom_pointrange(position = position_dodge(width=0.5)) +
  geom_text(aes(x=Estimate, y=hcc, label = round(Estimate, 0), fill = NULL, vjust = -1), colour = "#8e8e8e", size = 3) +
  geom_segment(x = 0, xend=0, y=0, yend = 6.1, linetype = "dashed", color = "grey") +
  annotate(geom = "text", x=0, y=6.3, label = "Cost offset", hjust=0.5, color = "grey") +
  xlim(-500, 1400) +
  expand_limits(y = c(1, 6.5)) +
  theme_modern() +
  theme(legend.position = "bottom") +
  labs(
    x = "PMPM savings",
    y = "",
    fill = " "
  )

```


# Therapy moderators

``` {r therapy-moderators}

# Calculate cumulative sessions
df_matched <- df_matched %>%
  group_by(carrier_member_id) %>%
  arrange(months) %>%
  mutate(
    session_count = case_when(
      spring_dummy == "Spring" ~ cumsum(spring_tx_count_month),
      spring_dummy == "Health Plan" ~ cumsum(carrier_tx_count_month)
    )
  ) %>%
  mutate(session_count_trunc = ifelse(session_count > 24, 24, session_count)) %>%
  mutate(session_count_total = max(session_count, na.rm=T))

# Let's look at non-mh spending only, since otherwise spending is complicated by spring spend not being included 
ggplot(df_matched, aes(x=session_count, y = med_pmpm_trunc_nonmh)) +
  geom_point() +
  geom_smooth() +
  facet_wrap(.~ months_post) +
  theme_modern() +
  ylim(0, 5000)


# Allow some nonlinearity
df_matched <- df_matched %>%
  mutate(
    therapy_sessions_factor = case_when(
      session_count == 0 ~ "0",
      session_count > 0 & session_count <= 2 ~ "1 to 2",
      session_count > 2 & session_count <= 5 ~ "3 to 5",
      session_count > 5 & session_count <= 12 ~ "6 to 12",
      session_count > 12 ~ "13+"
    ),
    any_therapy = ifelse(session_count > 0, "yes", "no")
  ) %>%
  mutate(therapy_sessions_factor = factor(therapy_sessions_factor, levels = c("0", "1 to 2", "3 to 5", "6 to 12", "13+")))

m_sessions0 <- lmer(med_pmpm_trunc_nonmh ~ 0 + spring_dummy:phase + spring_dummy:as.factor(session_count_trunc) + as.factor(months_post):spring_dummy + 
             (1 | carrier_member_id) +
             (1 | subclass_nn),
           weights = weights_nn,
           data = filter(df_matched))

m_sessions_numeric <- lmer(med_pmpm_trunc_nonmh ~ 0 + spring_dummy:phase + spring_dummy:session_count_trunc + as.factor(months_post):spring_dummy + 
             (1 | carrier_member_id) +
             (1 | subclass_nn),
           weights = weights_nn,
           data = filter(df_matched))

df_sessions <- m_sessions0 %>%
  broom.mixed::tidy() %>%
  filter(str_detect(term, "session_count")) %>%
  #mutate(term = str_replace(term, "spring_dummy", "")) %>%
  mutate(group = ifelse(str_detect(term, "Health Plan"), "Control", "Spring")) %>%
  mutate(sessions = str_extract(term,  "\\)(.*)")) %>%
  mutate(sessions = str_replace(sessions, "\\)", "")) %>%
  mutate(sessions = as.numeric(sessions))

ggplot(df_sessions, aes(x=sessions, y=estimate, group=group, color=group)) +
  geom_point() +
  geom_line() +
  geom_hline(yintercept = 0, linetype = "dashed") +
  theme_modern()

m_sessions1 <- lmer(med_pmpm_trunc_nonmh ~ 1 + spring_dummy + spring_dummy*phase + 
                     as.factor(months_post) + as.factor(months_post)*spring_dummy + 
                      any_therapy + session_count + session_count*spring_dummy + 
             (1 | carrier_member_id) +
             (1 | subclass_nn),
           weights = weights_nn,
           data = df_matched)

m_sessions2 <- lmer(med_pmpm_trunc_nonmh ~ 1 + spring_dummy + spring_dummy*phase + 
                     as.factor(months_post) + as.factor(months_post)*spring_dummy + 
                      therapy_sessions_factor + therapy_sessions_factor*spring_dummy + 
             (1 | carrier_member_id) +
             (1 | subclass_nn),
           weights = weights_nn,
           data = df_matched)

m_sessions3 <- lmer(med_pmpm_trunc_nonmh ~ 1 + spring_dummy + spring_dummy*phase + 
                     as.factor(months_post) + as.factor(months_post)*spring_dummy + 
                      therapy_sessions_factor + 
             (1 | carrier_member_id) +
             (1 | subclass_nn),
           weights = weights_nn,
           data = df_matched)

tab_model(m_sessions1, m_sessions2,
          drop = c("months_post", "(Intercept)", "phase"), 
          show.ci=F,
          show.icc = F,
          show.re.var = F,
          show.r2 = F,
          show.aic = T,
          dv.labels = c("Model 1", "Model 2"), 
          show.se=T)

```



``` {r monthly-cc-breakdown, fig.width=7, fig.height=7}

df_monthly_spend <- df_matched %>%
  group_by(spring_dummy, months) %>%
  summarize(
    pmpm_mh_ov = mean(med_pmpm_trunc_ov_mh, na.rm=T),
    pmpm_mh_er = mean(med_pmpm_trunc_er_mh, na.rm=T),
    pmpm_mh_op = mean(med_pmpm_trunc_hosp_op_mh, na.rm=T),
    pmpm_mh_ip = mean(med_pmpm_trunc_ip_mh, na.rm=T),
    pmpm_mh_therapy = mean(med_pmpm_therapy_mh_net),
    
    pmpm_nonmh_ov = mean(med_pmpm_trunc_ov_nonmh, na.rm=T),
    pmpm_nonmh_er = mean(med_pmpm_trunc_er_nonmh, na.rm=T),
    pmpm_nonmh_op = mean(med_pmpm_trunc_hosp_op_nonmh, na.rm=T),
    pmpm_nonmh_ip = mean(med_pmpm_trunc_ip_nonmh, na.rm=T),
    pmpm_nonmh_therapy = mean(med_pmpm_therapy_nonmh)
    ) %>%
  filter(months <= 12) %>%
  filter(months > 0) %>%
  pivot_longer(
    cols = c(pmpm_mh_ov:pmpm_nonmh_therapy),
    names_prefix = "pmpm_",
    names_to = "spend_cat",
    values_to = "estimate"
    ) %>%
  mutate(
    mh_spend = ifelse(str_starts(spend_cat, "mh_*"), "mh", "non-MH"),
    category = str_replace(spend_cat, ".*_", "")
  ) %>%
  mutate(
    mh_spend = ifelse(mh_spend == "mh", "Mental Health spend", "Non-MH spend"),
    category = case_when(
      category == "er" ~ "ER",
      category == "ip" ~ "Inpatient",
      category == "op" ~ "Outpatient",
      category == "ov" ~ "Office Visits",
      category == "therapy" ~ "Therapy"
    )
  ) %>%
  mutate(category = factor(category, levels = c("Therapy", "Office Visits", "ER", "Inpatient", "Outpatient")))

# Category level
ggplot(filter(df_monthly_spend, category != "Therapy"), aes(x=months, y=estimate, group = spring_dummy, fill = spring_dummy)) +
  geom_bar(stat = "identity", width = 0.6, position=position_dodge()) +
  scale_fill_manual(values = rev(cc_colors)) +
  #geom_text(aes(x=total, y=chronic_condition, label = round(total, 0), fill = NULL, hjust = ifelse(total < 0, 1.1, -0.4)), colour = "#8e8e8e", size = 3, data = df_labels) +
  #expand_limits(x=c(0, 1.1*max(df_labels$total))) +
  theme_modern() +
  facet_grid(rows=vars(category), cols=vars(mh_spend), scales = "fixed") +
  theme(legend.position = "bottom") +
  theme(strip.text = element_text(size = 14)) +
  labs(
    title = "Monthly spend by service category",
    x = "Months after Spring launch",
    y = "PMPM savings",
    fill = " "
  )

# MH vs non-MH
df_monthly_spend %>%
  group_by(spring_dummy, months, mh_spend) %>%
  summarize(estimate = sum(estimate, na.rm=T)) %>%
  # Plot
  ggplot(., aes(x=months, y=estimate, group = spring_dummy, fill = spring_dummy)) +
  geom_bar(stat = "identity", width = 0.6, position=position_dodge()) +
  scale_fill_manual(values = rev(cc_colors)) +
  #geom_text(aes(x=total, y=chronic_condition, label = round(total, 0), fill = NULL, hjust = ifelse(total < 0, 1.1, -0.4)), colour = "#8e8e8e", size = 3, data = df_labels) +
  #expand_limits(x=c(0, 1.1*max(df_labels$total))) +
  theme_modern() +
  facet_grid(rows=vars(mh_spend), scales = "fixed") +
  theme(legend.position = "bottom") +
  theme(strip.text = element_text(size = 14)) +
  labs(
    title = "Monthly spend for mental health and non-mental health conditions",
    x = "Months after Spring launch",
    y = "PMPM savings",
    fill = " "
  )

```

# ROI

## Calculate ROI
* Note: participant-year ROI multiple is too high because it is currently based on incomplete fees.
``` {r calculate-roi}
df_roi <- df_matched %>%
  filter(spring_dummy == "Spring") %>%
  filter(month_year == first_spring_tx_date) %>%
  mutate(months_treated = interval(first_spring_tx_date, spring_end_date) %/% months(1) + 1) %>%
  group_by(months_treated) %>%
  summarize(n = n_distinct(carrier_member_id)) %>%
  mutate(
    member_months_treated = n*months_treated,
    month_roi_gross = -1*n*months_treated*summary(m1_gross)$coefficients["spring_dummySpring:phasepost_tx", 1])
mean_months_treated <- sum(df_roi$member_months_treated)/sum(df_roi$n)


# First program year net savings %
deltamethod(m1_net, "0 = (6.5*b4) / ((12-6.5)*df_plot_total$estimate[1] + 6.5*(df_plot_total$estimate[2]))") # (PMPM savings / total control group spend)

# First Program-year PMPY
deltamethod(m1_net, "0 = -1 * b4 * mean_months_treated")

# Program-year ROI multiple
deltamethod(m1_net, "0 = (1 + (-1*b4 * sum(df_roi$member_months_treated)) / total_invoiced)")

```


# Sensitivity analysis

## Doubly-robust
``` {r doubly-robust}
m1_doubly_robust <- lmer(med_pmpm_trunc_net ~ 1 + spring_dummy + spring_dummy*phase + 
                           phase*(customer_name + age_at_index + member_sex + risk_score_log + dx_imputed) +
             (1 | carrier_member_id) +
             (1 | subclass_nn),
           weights = weights_nn,
           data = df_matched)
tab_model(m1_doubly_robust, show.ci=F, show.se=T)
```


## GLM with design weights - alternate specification of main effect weights
Multilevel models with design weights aren't super well-studied. Here we use an alternate specification using design weights--a common approach--and find much the same result.

``` {r glm-design-weights}
# Sensitivity - GLM with design weights
design_test <- svydesign(
  id = ~ subclass_nn + carrier_member_id, # members nested in customers. Order matters in this equation.
  weights = ~weights_nn, 
  data = df_matched) 

glm_design_weights <- svyglm(med_pmpm_trunc_net ~ 1 + spring_dummy + spring_dummy*phase,
                design = design_test)

summary(glm_design_weights) 

design_doubly_robust <- svyglm(med_pmpm_trunc_net ~ 1 + spring_dummy + spring_dummy*phase +
                                 phase*(customer_name + age_at_index + member_sex + risk_score_log + dx_imputed),
                design = design_test)
summary(design_doubly_robust)
```


## Parallel trends assumption
``` {r parallel-trends}

# Assess parallel trends
df_plot_trend <- df_matched %>%
  group_by(spring_dummy, months) %>%
  summarize(
    pmpm = mean(med_pmpm_trunc_net, na.rm=T),
    sd = sd(med_pmpm_trunc_net, na.rm=T),
    n = n_distinct(carrier_member_id),
    se = sd/sqrt(n)
    ) 

parallel_trend <- lmer(pmpm ~ months + spring_dummy + months*spring_dummy + (1 | carrier_member_id) + (1 | subclass_nn), data = filter(df_matched, months <= 0))
ptrend_results <- hypotheses(parallel_trend, "b4=0") %>% mutate(across(c(2:7), ~round(.x,2)))

ggplot(filter(df_plot_trend, months <= 0), aes(x=months, y=pmpm, ymin = pmpm - 1.96*se, ymax = pmpm + 1.96*se, group = spring_dummy, color=spring_dummy)) +
  geom_vline(xintercept = 0, linetype = "dotted") +
  geom_pointrange() +
  geom_line() +
  geom_smooth(method = "lm", se = F, linetype = "dashed") +
  scale_color_manual(values = color_scheme, labels = c("Control", "Program")) +
  annotate("text", x=-11, y=750, label = paste0("Multilevel regression test of group difference in linear trend \nb = ", ptrend_results[[2]], " [95% CI, ", ptrend_results[[6]], " to ", ptrend_results[[7]], "], p = ", ptrend_results[[5]]), size=3.5, hjust=0) +
  ylim(100, 800) +
  theme_modern() +
  theme(
    legend.position = "bottom",
    strip.text.x = element_blank()
    ) +
  labs(title = "Assessment of parallel trends in the year prior to index date",
       x = "Months prior to index date")

```

## Trajectory analysis
``` {r trajectory-analysis}

# Plot raw
ggplot(df_plot_trend, aes(x=months, y=pmpm, ymin = pmpm - 1.96*se, ymax = pmpm + 1.96*se, group = spring_dummy, color=spring_dummy)) +
  geom_vline(xintercept = 0, linetype = "dotted") +
  geom_pointrange() +
  geom_line() +
  theme_modern() +
  theme(
    legend.position = "none",
    strip.text.x = element_blank()
    ) +
  labs(title = "Net ROI")


## Make it disappear by plotting from launch date
## Approximate net ROI
df_matched %>%
  mutate(months_from_launch = interval(spring_start_date, month_year) %/% months(1) + 1) %>%
  group_by(spring_dummy, months_from_launch) %>%
  summarize(
    pmpm = mean(med_pmpm_trunc_net, na.rm=T),
    sd = sd(med_pmpm_trunc_net, na.rm=T),
    n = n_distinct(carrier_member_id),
    se = sd/sqrt(n)
    ) %>%
  filter(months_from_launch <= 12) %>%
  ggplot(., aes(x=months_from_launch, y=pmpm, ymin = pmpm - 1.96*se, ymax = pmpm + 1.96*se, group = spring_dummy, color=spring_dummy)) +
  geom_vline(xintercept = 0, linetype = "dotted") +
  geom_pointrange() +
  geom_line() +
  scale_color_manual(values = rev(cc_colors), labels = c("Control", "Spring Health")) +
  theme_modern() +
  theme(
    legend.position = "none",
    strip.text.x = element_blank()
    ) +
  labs(
    x = "Months from Spring launch",
    y = "PMPM ($)",
    title = "Make it disappear by plotting from launch date")


# Make and plot splines
## Fit spline model
m1_spline <- lmer(med_pmpm_trunc_net ~ 1 + spring_dummy + spring_dummy*phase +
                    spring_dummy*(ns(months_post, df = 4)) +
                    (1 | carrier_member_id) +
                    (1 | subclass_nn),
                  weights = weights_nn,
                  data = df_matched)

df_pred <- df_matched %>%
  distinct(spring_dummy, phase, months, months_post)

  df_plot_splines <- predictions(
    m1_spline,
    newdata = df_pred,
    re.form = ~0)
  
ggplot(df_plot_splines, aes(x=months, y=estimate, ymin = conf.low, ymax=conf.high, group = spring_dummy, color=spring_dummy)) +
  geom_line() +
  geom_pointrange() +
  theme_modern() +
  theme(
    legend.position = "none",
    strip.text.x = element_blank()
  ) +
    labs(title = "Net ROI")
```



## Do session counts differ for individuals with high cost conditions?
``` {r cc-session-counts}
df_cc_table <- df_match_table %>%
  mutate(cc_group = case_when(
    cc_cancer == "yes" ~ "Cancer",
    cc_hypertension == "yes" ~ "Hypertension",
    excl_pregnancy == "yes" ~ "Pregnancy",
    cc_diabetes == "yes" ~ "Diabetes",
    cc_asthma_copd == "yes" ~ "Asthma/COPD",
    TRUE ~ "No chronic condition"
  )) 

table1( ~ age_at_index + member_sex + dx_imputed + risk_score_dx + months_diagnosed + any_bh + bh_if_engaged | spring_dummy*cc_group,
        overall = T,
        footnote = "This table is based on raw values. In cases where 2 matches were not achieved, weights were applied.",
        data=df_cc_table)
```

## Participant-year trajectories
``` {r participant-year-trajectories}

m_1yr_participant <- lmer(med_pmpm_trunc_net ~ 1 + spring_dummy + as.factor(months_post) +
                          spring_dummy*as.factor(months_post) + 
                             (1 | carrier_member_id) +
                             (1 | subclass_nn),
                           weights = weights_nn,
                           data = df_matched)

tab_model(m_1yr_participant, show.ci=F, show.se=T)

# Get PPPY in dollars
hypotheses(m_1yr_participant, hypothesis = "b15 + b16 + b17 + b18 + b19 + b20 + b21 + b22 + b23 + b24 + b25 + b26 = 0")

# Get PPPY in pct
hypotheses(m_1yr_participant, hypothesis = "(b15 + b16 + b17 + b18 + b19 + b20 + b21 + b22 + b23 + b24 + b25 + b26) /
          (b1*12 + b3 + b4 + b5 + b6 + b7 + b8 + b9 + b10 + b11 + b12 + b13 + b14)  = 0")

# Plot
df_plot_participant_year <- df_matched %>%
  ungroup() %>%
  distinct(spring_dummy, months, months_post) 

df_plot_participant_year <- predictions(m_1yr_participant, newdata = df_plot_participant_year,  re.form = ~0)
monthly_avg_did <- pull(hypotheses(m_1yr_participant, hypothesis = "b15 + b16 + b17 + b18 + b19 + b20 + b21 + b22 + b23 + b24 + b25 + b26 = 0")[2]/12)

# Overall with error bars
ggplot(df_plot_participant_year, aes(x=months, y=estimate, ymin=conf.low, ymax=conf.high, group = spring_dummy, color = spring_dummy)) +
  geom_errorbar(width = 0.25) +
  geom_point(size=3) +
  geom_line() +
  scale_color_manual(values = color_scheme, labels = c("Control", "Spring Health")) +
  annotate(geom = "text", x=7, y=1200, label = paste0("Savings = $", round(-1*monthly_avg_did, 0), " PMPM"), color = "#37837c", fontface = "bold") +
  theme_modern() +
  theme(legend.position = "bottom") +
  labs(
    title = "Spend trajectories for Spring Health versus control group",
    x = "",
    y = "PMPM allowed amount",
    color = ""
  )

# Plot cumulative ROI
generate_b_string <- function(b) {
  # Generate the sequence of elements
  elements <- sapply(1:b, function(i) paste("b", 15+i-1, sep=""))
  
  # Combine elements into a single string with " + " as separator
  result_string <- paste(elements, collapse = " + ")
  
  return(result_string)
}
net_fun <- function(x) {hypotheses(m_1yr_participant, hypothesis = paste0(generate_b_string(x), "= 0"))}

df_plot_cumulative <- data.frame(months_post = seq(1, 12, 1)) %>%
  rowwise() %>%
  mutate(
    net_cumulative = -1*net_fun(months_post)[[2]],
    lb = -1*net_fun(months_post)[[6]],
    ub = -1*net_fun(months_post)[[7]]
) %>%
  ungroup() %>%
  data.frame() 

# people like bar plots
ggplot(df_plot_cumulative, aes(x=months_post, y=net_cumulative, ymin=lb, ymax=ub)) +
  geom_bar(stat = "identity", fill = "#34a853") +
  geom_pointrange(color = "grey") +
  theme_modern() +
  scale_x_continuous(breaks = seq(1,12,1)) +
  labs(
    title = "Cumulative ROI from first month of treatment",
    x = "Months from first treatment",
    y = "$, cumulative"
  )

# ... but line plots are better for understanding the data
ggplot(df_plot_cumulative, aes(x=months_post, y=net_cumulative, ymin=lb, ymax=ub)) +
  geom_smooth(se=FALSE) +
  geom_pointrange(color = "grey") +
  theme_modern() +
  scale_x_continuous(breaks = seq(1,12,1)) +
  labs(
    title = "Cumulative ROI from first month of treatment",
    x = "Months from first treatment",
    y = "$, cumulative"
  )

```


## Stratification by BH treatment
Do we get more savings versus the control group that did not engage in BH treatment? No. 

We have more net savings on mental health spend compared to the control group members that engaged in MH care. Physical health savings are the same in both groups. Don't love that finding as it undermines the narrative the MH treatment provides physical health savings. 

Based on sessions alone, I think we can make the argument that we have more efficient care than the control group, which dovetails with what Dan Harrah was saying about Lyra's length of care in our ROI narrative meeting. We have already shown that we get gold standard clinical outcomes due to MBC, so we can argue that at Spring people get the right amount of care and aren't trapped in therapy endlessly after they don't need it. But I worry that Lyra could make the argument that 4 sessions is not a full course of care and we aren't delivering the care our patients need. Not sure how much to worry about what Lyra would say, though.

``` {r sensitivity}

# Make 3 groups
df_match_table <- df_match_table %>%
  mutate(spring_dummy_stratified = case_when(
    spring_dummy == "Control" & any_bh == "no" ~ "Control, no BH appt",
    spring_dummy == "Control" & any_bh == "yes" ~ "Control group with BH appt",
    spring_dummy == "Spring Health" ~ "Spring Health"
  ))
  
table1( ~ any_bh + session_count_total | spring_dummy_stratified,
        overall = F,
        footnote = "This table is based on raw values. In cases where 2 matches were not achieved, weights were applied.",
        data=df_match_table)

# Group by BH usage
df_matched <- df_matched %>%
  group_by(carrier_member_id) %>%
  arrange(months) %>%
  mutate(
    therapy_sessions_total = sum(spring_therapist_count_month, carrier_therapist_count_month, na.rm=T),
    session_count_total = sum(spring_tx_count_month, carrier_tx_count_month, na.rm=T)
  ) %>%
  mutate(any_bh = ifelse(session_count_total > 0, "yes", "no")) %>%
  mutate(spring_dummy_stratified = case_when(
    spring_dummy == "Health Plan" & any_bh == "no" ~ "Control, no BH appt",
    spring_dummy == "Health Plan" & any_bh == "yes" ~ "Control, yes BH appt",
    spring_dummy == "Spring" ~ "Spring Health"
  )) %>%
  mutate(spring_dummy_stratified = factor(spring_dummy_stratified, levels = c("Spring Health", "Control, no BH appt", "Control, yes BH appt")))

df_matched <- df_matched %>%
  mutate(session_count_trunc = ifelse(session_count_total > 24, 24, session_count_total))


m1_bh_overall <- lmer(med_pmpm_trunc_net ~ 1 + spring_dummy_stratified + spring_dummy_stratified:phase +
             (1 | carrier_member_id) +
             (1 | subclass_nn),
           weights = weights_nn,
           data = df_matched)
  
m1_bh_mh_spend <- lmer(med_pmpm_trunc_mh_net ~ 1 + spring_dummy_stratified + spring_dummy_stratified:phase +
             (1 | carrier_member_id) +
             (1 | subclass_nn),
           weights = weights_nn,
           data = df_matched)

m1_bh_nonmh_spend <- lmer(med_pmpm_trunc_nonmh ~ 1 + spring_dummy_stratified + spring_dummy_stratified:phase +
             (1 | carrier_member_id) +
             (1 | subclass_nn),
           weights = weights_nn,
           data = df_matched)

tab_model(m1_bh_overall, m1_bh_mh_spend, m1_bh_nonmh_spend,
          show.ci=F, 
          show.se=T,
          pred.labels = c("Baseline Spring PMPM", "Baseline difference (Spring - Control, no BH)", "Baseline difference (Spring - Control, yes BH)", "Spring pre-post change", "Diff-in-diff (Control no BH change - Spring change)", "Diff-in-diff (Control yes BH change - Spring change)"),
          dv.labels = c("Model 1 - Total medical spend", "Model 2 - Mental health spend", "Model 3 - Physical health spend"))
```


## Drop those with month 1 inpatient spend
``` {r drop-inpatient}

df_matched <- df_matched %>%
  group_by(subclass_nn) %>%
  mutate(
    ip_month1 = sum(med_pmpm_trunc_ip_nonmh[months==1], na.rm=T),
    ip_months1_to_3 = sum(med_pmpm_trunc_ip_nonmh[months==1 | months==2 | months==3], na.rm=T)
    ) 

m1_drop_month1_ip <- lmer(med_pmpm_trunc_net ~ 1 + spring_dummy + spring_dummy*phase + 
             (1 | carrier_member_id) +
             (1 | subclass_nn),
           weights = weights_nn,
           data = filter(df_matched, ip_month1==0))

tab_model(m1_net, m1_drop_month1_ip, show.ci=F, show.se=T,
          dv.labels = c("All participants", "Drop participants with month 1 inpatient physical health spend"))
```
