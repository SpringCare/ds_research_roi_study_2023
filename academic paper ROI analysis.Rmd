---
title: "ROI study 2023"
output:
  html_document:
    toc: yes
    toc_float: yes
    number_sections: yes
    code_folding: hide
    theme: lumen
  word_document:
    toc: yes
  pdf_document:
    toc: yes
---


```{r setup, include = F}
knitr::opts_chunk$set(echo = TRUE, 
               warning = FALSE,
               message = FALSE,
               fig.path='figures/',
               fig.width = 7, 
               fig.height = 5)
options(DT.options = list(pageLength = 100, language = list(search = 'Filter:')))

knitr::opts_knit$set(root.dir = '~/Library/CloudStorage/GoogleDrive-mhawrilenko@springhealth.com/Shared drives/Data Science/people/matt/ds_git/ds_research_roi_study_2023/code')
```


```{r load-packages, message = FALSE, results = 'hide'}
# load packages
library(knitr)
library(tidyverse)
library(nerdify)
library(janitor)
library(rio)
library(lubridate)
library(table1)
library(lme4)
library(lmerTest)
library(lmeresampler)
library(nnet)
library(foreach)
library(doParallel)
library(car)
library(sjPlot)
library(ggplot2)
library(ggrepel)
library(cowplot)
library(marginaleffects)
library(see)
library(kableExtra)
library(gt)
```


# Load data and functions

## Claims data 
``` {r load-data}

# Customers included in the study
customer_name <- c("Wellstar", "Pepsi", "Hearst", "Docusign", "Tegna")

# Make some lists to fill up
data_funnel <- list()
df_care_use <- list()
df_appts <- list()

# Get datasets that have not yet been concatenated
for (i in 1:length(customer_name)) {
# Load data
data_funnel[[i]] <- readRDS(paste0(Sys.getenv("claims_folder_path"), "data/round_2_analysis/", customer_name[i], "/", customer_name[i], "_data_funnel.Rdata")) %>%
  mutate(customer_name = customer_name[i]) 
df_care_use[[i]] <- readRDS(paste0(Sys.getenv("claims_folder_path"), "data/round_2_analysis/", customer_name[i], "/", customer_name[i], "_care_use.Rdata"))
df_appts[[i]] <- readRDS(paste0(Sys.getenv("claims_folder_path"), "data/round_2_analysis/", customer_name[i], "/", customer_name[i], "_appts_by_month.Rdata"))
}

# Now bind into a single df
data_funnel <- data_funnel %>% bind_rows()
df_care_use <- df_care_use %>% bind_rows()
df_appts <- df_appts %>% bind_rows()

# Now the dfs that have previously been concatenated
df_analyze_all <- readRDS(paste0(Sys.getenv("claims_folder_path"), "data/roi_study_2023/df_analyze_all.Rdata"))
df_matched <- readRDS(paste0(Sys.getenv("claims_folder_path"), "data/roi_study_2023/df_matched.Rdata"))

```


## Billing data
``` {r billing-data}

# direct bill

## all direct bill appts
billing_appts <- readRDS('~/Library/CloudStorage/GoogleDrive-mhawrilenko@springhealth.com/Shared drives/ROI - Direct bill/HEOR clean/billing data.Rdata')

# Loop stuff
spring_fees <- list()
prop_matched <- vector()
for (i in 1:length(customer_name)) {
  
  ## Get covered life IDs for members in the study
spring_match_to_elig <- import(paste0(Sys.getenv("claims_folder_path"), "data/", customer_name[i], "/data_to_sba/", customer_name[i], "_", "eligibility_cls.csv")) %>%
  rename(any_of(c(
    carrier_member_id = "member_key",
    carrier_member_id = "indv_id",
    carrier_member_id = "individual_id"
  ))) %>%
  mutate(carrier_member_id = as.character(carrier_member_id)) %>%
  select(carrier_member_id, covered_life_id)


## Need members in the study
study_members <- df_matched %>%
  distinct(carrier_member_id, spring_dummy) %>%
  left_join(spring_match_to_elig)


## Match study members to their appts
apps_query <- "SELECT appointment_id, covered_life_id 
               FROM base_appointments 
               WHERE UPPER(customer_name) like ?"


apps <- dbGetQuery(con = snowflake_conn("base_layer"), apps_query, params = list(paste0('%', str_to_upper(customer_name[i]), '%'))) %>%
  clean_names()


## Calculate direct bill amounts by group
spring_start_date <- df_matched %>%
  ungroup() %>%
  filter(str_like(customer_name, paste0('%', .env$customer_name[i], '%'), ignore_case = TRUE)) %>%
  distinct(spring_start_date) %>%
  pull(spring_start_date) 

spring_end_date <- df_matched %>%
  ungroup() %>%
  filter(str_like(customer_name, paste0('%', .env$customer_name[i], '%'), ignore_case = TRUE)) %>%
  distinct(spring_end_date) %>%
  pull(spring_end_date) 

direct_bill <- billing_appts %>%
  filter(str_like(customer_name, paste0('%', .env$customer_name[i], '%'), ignore_case = TRUE)) %>% #.env$customer_name
  filter(month_of_service <= spring_end_date) %>%
  left_join(apps) %>% # get covered life id
  inner_join(study_members) %>% # only individuals included in the study
  ## sometimes an individual has multiple carrier member IDs. DOn't want duplicate billing. 
  ## so group by appointment_id and take first carrier_member_id
  group_by(appointment_id) %>% 
  filter(carrier_member_id == first(carrier_member_id) | is.na(carrier_member_id)) %>% # address billing data that gets duped
  ungroup() %>%
  summarize(amount = sum(total_billed, na.rm=T)) %>%
  pull(amount)


billing_all <- import(paste0(Sys.getenv("claims_folder_path"), "data/", customer_name[i], "/", customer_name[i], "_", "billing.xlsx")) %>%
  clean_names()

bundle_fee <- billing_all %>%
  filter(str_like(account, paste0('%', "bundle", '%'), ignore_case = TRUE)) %>%
  summarize(bundle_fee = sum(amount, na.rm=T)) %>%
  pull(bundle_fee)

platform_fee <- billing_all %>%
  filter(str_like(account, paste0('%', "platform", '%'), ignore_case = TRUE)) %>%
  summarize(platform_fee = sum(amount, na.rm=T)) %>%
  pull(platform_fee)

billed_to_health_plan <- readRDS(paste0(Sys.getenv("claims_folder_path"), "data/round_2_analysis/intermediate_data/", customer_name[i], "_spring_med_claims.Rdata")) %>%
  filter(month_year <= spring_end_date) %>%
  mutate(carrier_member_id = as.character(carrier_member_id)) %>%
  inner_join(study_members) %>%
  ungroup() %>%
  summarize(billed_to_health_plan = sum(allowed_amt, na.rm=T)) %>%
  pull(billed_to_health_plan)


## Get number of eligible employees on the health plan in the date range
elig <- readRDS(file = paste0(Sys.getenv("claims_folder_path"), "/data/round_2_analysis/intermediate_data/", customer_name[i], "_carrier_elig.Rdata")) %>%
  filter(month_year >= spring_start_date) %>%
  filter(month_year <= spring_end_date) %>%
  filter(employee_flag == "yes") 

## Get total employees
qry <- "SELECT DISTINCT a.customer_name, a.customer_id, id, dependent, b.created_at
                  FROM ds_trunk.base_layer.base_customers AS a
                  LEFT JOIN stitch_new.rotom_prod_replica.covered_lives AS b
                  ON a.customer_id = b.customer_id
                  WHERE UPPER(a.customer_name) LIKE ?
                  AND dependent = 'FALSE'
                  AND DATE(b.created_at) <= date(?)"

cl <- dbGetQuery(con = snowflake_conn("rotom"), qry, params = list(paste0('%', str_to_upper(customer_name[i]), '%'), spring_end_date)) %>%
  clean_names()

prop_on_health_plan <- n_distinct(elig$carrier_member_id) / n_distinct(cl$id)

cust_funnel <- data_funnel %>%
  filter(customer_name == .env$customer_name[i]) 
prop_matched <- pull(cust_funnel[7,4] / cust_funnel[1,4])

# Compile all fees
spring_fees[[i]] <- data.frame(
  fee_type = c("Bundle", "Platform", "Direct bill", "Billed to Health Plan")
) %>%
  mutate(
    customer_name = customer_name[i],
    prop_on_health_plan = prop_on_health_plan,
    prop_matched = prop_matched,
    Amount = case_when(
      fee_type == "Bundle" ~ bundle_fee * prop_on_health_plan * prop_matched,
      fee_type == "Platform" ~ platform_fee * prop_on_health_plan * prop_matched,
      fee_type == "Direct bill" ~ direct_bill,
      fee_type == "Billed to Health Plan" ~ billed_to_health_plan
    )
)
}
spring_fees <- spring_fees %>% bind_rows()

spring_fees %>%
  group_by(customer_name) %>%
  summarize(amount = sum(Amount, na.rm=T)) 

total_invoiced <- spring_fees %>%
  summarize(amount = sum(Amount, na.rm=T)) %>%
  pull(amount)

# Get monthly Spring costs
member_months <- df_matched %>% ungroup() %>% filter(spring_dummy == "Spring", months_post>=1) %>% summarize(n=n()) %>% pull()
spring_pmpm_adjustment <- total_invoiced/member_months
effective_session_fee <- sum(spring_fees$Amount) / sum(df_matched$spring_tx_count_month, na.rm = T)

```


# Analyze utilization pre and post launch
Spring promises to drive value by getting more people into care who otherwise would never have received it. Here, we test this premise by determining how much mental health treatment utilization changed after Spring launched. Here, we examine 3 metrics:  
  1. How annual outpatient behavioral health treatment utilization changed pre and post Spring  
  2. Any utilization by month  
  3. Number of sessions per month 
  
  
# Annual utilization

``` {r cust-avg-utilization, fig.width = 10, fig.height = 5}

df_phase_summary <- df_care_use %>%
  filter(month_year >= baseline_start_date) %>%
  filter(month_year <= spring_end_date) %>%
  mutate(phase = ifelse(month_year < spring_start_date, "Pre-launch", "Post-launch")) %>%
  mutate(phase = factor(phase, levels = c("Pre-launch", "Post-launch"))) %>%
  group_by(customer_name, carrier_member_id, phase) %>%
  summarize(
    carrier_tx_count_month = sum(carrier_tx_count_month),
    spring_tx_count_month = sum(spring_tx_count_month),
    carrier_therapist_count_month = sum(carrier_therapist_count_month),
    spring_therapist_count_month = sum(spring_therapist_count_month)
  ) %>%
  ungroup() %>%
  mutate(
    mh_appt_group = factor(case_when(
      carrier_tx_count_month > 0 & spring_tx_count_month > 0 ~ "Both Spring and Health Plan",
      carrier_tx_count_month > 0 & spring_tx_count_month == 0 ~ "Health Plan only",
      carrier_tx_count_month == 0 & spring_tx_count_month > 0 ~ "Spring only",
      carrier_tx_count_month == 0 & spring_tx_count_month == 0 ~ "No appointments"
    ),
    levels = c("Spring only", "Both Spring and Health Plan", "Health Plan only", "No appointments")
    ))

care_use_avg <- df_phase_summary %>%
  group_by(customer_name, phase, mh_appt_group) %>%
  summarize(group_n = n()) %>%
  group_by(customer_name, phase) %>%
  mutate(proportion = group_n/sum(group_n)) %>%
  filter(mh_appt_group != "No appointments") %>%
  group_by(phase, mh_appt_group) %>%
  summarize(proportion = mean(proportion)) %>%
  mutate(proportion = round(100*proportion, 1))
  

# Plot
color_scheme <- c("#37837c","#A9DbD6", '#c7c7c7') # set colors

## plot
ggplot(care_use_avg, aes(x = phase, y=proportion, group = mh_appt_group, fill = mh_appt_group)) +
  geom_bar(position="stack", stat="identity", width = 0.5) +
  scale_fill_manual(values = color_scheme, name = "Provider") +
  geom_text(aes(label=proportion), position = position_stack(vjust = 0.5), colour = "black") +
  theme_modern() +
  labs(
    title = "Members using any outpatient behavioral health care in the year",
    x = "",
    y = "Percent",
    group = "",
    fill = ""
  )

# Model 

## Overall
df_phase_summary <- df_phase_summary %>%
  mutate(any_utilization = ifelse(mh_appt_group == "No appointments", "no", "yes"))

m_overall_util <- multinom(any_utilization ~ -1 + customer_name:phase,
            data = df_phase_summary) 

mnom_avg <- function(x) exp(x) / (1 + exp(x))
hypotheses(m_overall_util, "(
           (exp(b1) / (1 + exp(b1))) +
           (exp(b2) / (1 + exp(b2))) +
           (exp(b3) / (1 + exp(b3))) +
           (exp(b4) / (1 + exp(b4))) +
           (exp(b5) / (1 + exp(b5)))
           ) / 5 = 0
           ")

predictions(m_overall_util, newdata = df_phase_summary %>% distinct(customer_name, phase), type = "probs") %>%
  arrange(phase)


## Model pre-phase
m1_util <- multinom(mh_appt_group ~ customer_name,
            data = filter(df_phase_summary, phase == "Pre-launch"))

## Model post-phase
m2_util <- multinom(mh_appt_group ~ customer_name,
            data = filter(df_phase_summary, phase == "Post-launch"))

predictions(m1_util, newdata = df_phase_summary %>% distinct(customer_name), type = "probs")
predictions(m2_util, newdata = df_phase_summary %>% distinct(customer_name), type = "probs") 
```


## Monthly utilization
``` {r monthly-utilization}

# Monthly utilization
plot_monthly_avg <- df_care_use %>%
  filter(month_year >= baseline_start_date) %>%
  filter(month_year <= spring_end_date) %>%
  mutate(
    months_std = case_when(
      month_year < spring_start_date ~ interval(spring_start_date, month_year) %/% months(1),
      month_year >= spring_start_date ~ interval(spring_start_date, month_year) %/% months(1) + 1
    ),
    phase = ifelse(month_year < spring_start_date, "Pre-launch", "Post-launch"),
    provider = "Spring"
    ) %>%
  group_by(customer_name, mh_appt_group, months_std) %>%
  summarize(
    mh_appt_in_month = sum(mh_appt_in_month == "yes"),
    group_n = n()
    ) %>%
  group_by(customer_name, months_std) %>%
  mutate(n = sum(group_n)) %>%
  mutate(
    mh_appt_in_month_proportion = mh_appt_in_month/n,
    mh_appt_group = case_when(
      mh_appt_group == "Carrier only" ~ "Health Plan only",
      mh_appt_group == "Both Spring and Carrier" ~ "Both Spring and Health Plan",
      TRUE ~ mh_appt_group)
    ) %>%
  mutate(mh_appt_group = factor(mh_appt_group, levels = c("Spring only", "Both Spring and Health Plan", "Health Plan only"))) %>%
  filter(mh_appt_group != "No appointments") %>%
  group_by(months_std, mh_appt_group) %>%
  summarize(mh_appt_in_month_proportion = mean(mh_appt_in_month_proportion)) %>%
  arrange(mh_appt_group, months_std)


## Plot

## Make some plotting locations
pre_mean_avg <- round(
  sum(plot_monthly_avg$mh_appt_in_month_proportion[plot_monthly_avg$months_std < 0])/12, 
  3)
post_mean_avg <- round(
  sum(plot_monthly_avg$mh_appt_in_month_proportion[plot_monthly_avg$months_std > 0])/12,
  3)
max_avg <-max(
  plot_monthly_avg %>%
    group_by(months_std) %>%
    summarize(apps_in_month = sum(mh_appt_in_month_proportion)) %>%
    pull(apps_in_month)
)

## Plot
ggplot(plot_monthly_avg, aes(x = months_std, y=mh_appt_in_month_proportion, group = mh_appt_group, fill = mh_appt_group)) +
  geom_bar(position="stack", stat="identity") +
  scale_fill_manual(values = color_scheme, name = "Provider") +
  theme_modern() +
  geom_hline(yintercept = pre_mean_avg, linetype = "dashed") +
  geom_vline(xintercept = 0, color = "#48ADA3", linetype = "dashed") +
  theme(axis.text.x = element_text(angle = 70, vjust = 1, hjust=1)) +
  annotate(geom = "text", x = 3, y = max_avg*1.4, label = "Spring launch", color = "#37837c", size = 5) +
  annotate(geom = "text", x = -6.5, y = pre_mean_avg*1.2, label = paste0("Pre-launch = ", 100*pre_mean_avg, "% per month"), color = "#767676", size = 4) +
  annotate(geom = "text", x = 6.5, y = post_mean_avg*1.2, label = paste0("Post-launch = ", 100*post_mean_avg, "% per month"), color = "#37837c", size = 4) +
  labs(
    title = "Employees with at least 1 MH appointment",
    x = "Months from Spring launch",
    y = "Proportion"
  )

```


# Cohort comparisons
To determine Spring's impact on `r customer_name`'s total cost of care, we conducted a matching study. We identified the group of people who engaged with a Spring provider, a risk-matched group that did not use Spring, and compared the spend of both groups. Research demonstrates that spend increases at the time of a mental health diagnosis, so we compared changes in each group's spending from the year prior to receiving a MH diagnosis to the year after receiving a diagnosis, using a difference-in-differences design. 
  
  
## Data funnel
This table shows each step where participants were funneled into the analytic sample.
```{r data-funnel}

match_funnel <- df_matched %>% 
  group_by(spring_dummy) %>%
  summarize(
    n = n_distinct(carrier_member_id),
    filter_name = "Maintained in matching study"
    ) %>%
  mutate(total_n = sum(n)) %>%
  pivot_wider(
    id_cols = c(filter_name, total_n),
    names_from = spring_dummy,
    values_from = n
  ) 

data_funnel %>%
  group_by(filter_name) %>%
  summarize(across(-customer_name, sum)) %>%
  rbind(match_funnel) %>%
  arrange(-total_n) %>%
  kbl(caption = "Participant funnel through inclusion criteria") %>%
  kable_classic(full_width = T, html_font = "Cambria") 
```


## Summarize unmatched data
Prior to conducting matching, we examined key risk characteristics of the pool of potential study participants. From this table, we can see that prior to match, the Spring group consisted of slightly more women, more individuals in the 25-44 age category, had slightly lower medical spending risk scores, and comparatively more mood and anxiety diagnoses and fewer substance use diagnoses.

``` {r summary}
df_unmatched_table <- df_analyze_all %>%
  filter(index_date >= spring_start_date) %>%
  group_by(carrier_member_id, spring_dummy, age_at_index, member_sex, cc_any, cc_asthma_copd, cc_diabetes, cc_hypertension, cc_heart, cc_stroke, cc_kidney, cc_osteo, cc_cancer) %>%
  arrange(month_year) %>%
  summarize(
    carrier_mh_dx = first(carrier_primary_mh_dx, na_rm = TRUE),
    spring_mh_dx = first(spring_primary_mh_dx, na_rm = TRUE),
    risk_score_dx = risk_score[months == 1]
  ) %>%
  ungroup() %>%
  mutate(mh_dx = coalesce(spring_mh_dx, carrier_mh_dx)) %>%
  mutate(dx_collapsed = fct_collapse(mh_dx,
                                   mood = "mood",
                                   anxiety = "anxiety",
                                   sud = "sud",
                                   other = c("personality", "psychotic", "intellectual disability", "physical behavioral", "physiological", "developmental", "child onset", "unspecified")
  )) %>%
  select(-c(carrier_mh_dx, spring_mh_dx)) %>%
  ungroup()

## Examine overall table
### NOTE: p-value function is broken so currently dropping
table1( ~ age_at_index + member_sex + mh_dx + dx_collapsed + risk_score_dx + cc_any + cc_asthma_copd + cc_diabetes + cc_hypertension + cc_heart
        + cc_stroke + cc_kidney + cc_osteo + cc_cancer | spring_dummy,
        overall = F,
        render.missing = NULL,
       render.categorical = "FREQ (PCTnoNA%)",
        data=df_unmatched_table)
```

  
  
  
## Summarize matched data
We matched on age, sex, mental health diagnosis, and medical spending risk scores (Department of Health and Human Services - Hierarchal Condition Categories - platinum tier). We matched on a ratio to include as many relevant participants from the comparison condition as possible. In total, we matched X spring participants to Y participants in the comparison group. After matching, the groups were essentially identical across all key characteristics. 

``` {r compare-match-groups}
df_match_table <- df_matched %>%
  group_by(carrier_member_id) %>%
  arrange(months) %>%
  mutate(
    therapy_sessions_cum = case_when(
      spring_dummy == "Spring" ~ cumsum(spring_therapist_count_month),
      spring_dummy == "Health Plan" ~ cumsum(carrier_therapist_count_month)
    ),
    therapy_sessions_total = sum(spring_therapist_count_month, carrier_therapist_count_month, na.rm=T),
    session_count_total = sum(spring_tx_count_month, carrier_tx_count_month, na.rm=T),
    months_diagnosed = interval(index_date, spring_end_date) %/% months(1) + 1,
    cc_any2 = case_when(
      cc_cancer == "yes" ~ "yes",
      cc_hypertension == "yes" ~ "yes",
      cc_diabetes == "yes" ~ "yes",
      excl_pregnancy == "yes" ~ "yes",
      cc_asthma_copd == "yes" ~ "yes",
      TRUE ~ "no"
    )
  ) %>%
  mutate(
    any_bh = ifelse(session_count_total > 0, "yes", "no"),
    bh_if_engaged = ifelse(session_count_total > 0, session_count_total, NA),
    therapy_if_engaged = ifelse(therapy_sessions_total > 0, therapy_sessions_total, NA)
    ) %>%
  group_by(carrier_member_id, cc_any2, cc_asthma_copd, cc_diabetes, cc_hypertension, cc_cancer, excl_pregnancy) %>%
  arrange(months) %>%
  slice_head() %>%
  ungroup() %>%
  mutate(spring_dummy = factor(spring_dummy, labels = c("Control", "Spring Health"))) 
  

# Add labels
label(df_match_table$age_at_index) <- "Age"
label(df_match_table$member_sex) <- "Sex (assigned at birth)"
label(df_match_table$dx_imputed) <- "Mental health diagnosis"
label(df_match_table$risk_score_dx) <- "Risk score at time of diagnosis"
label(df_match_table$months_diagnosed) <- "Months with diagnosis"
label(df_match_table$therapy_sessions_total) <- "Number of therapy sessions"
label(df_match_table$session_count_total) <- "Number of behavioral health sessions, all participants"
label(df_match_table$any_bh) <- "Engaged in outpatient behavioral health treatment"
label(df_match_table$bh_if_engaged) <- "Number of behavioral health sessions, engagers only"

# NOTE: p-value function is broken here so currently dropping
table1( ~ age_at_index + member_sex + dx_imputed + risk_score_dx + months_diagnosed + cc_any2 + cc_asthma_copd + cc_diabetes + cc_hypertension + cc_kidney + cc_osteo + cc_cancer + excl_pregnancy | spring_dummy,
        overall = F,
        footnote = "This table is based on raw values. In cases where 2 matches were not achieved, weights were applied.",
        data=df_match_table)


# Drop median, min, max
render.cont <- function(x) {
    with(stats.apply.rounding(stats.default(round(x, 1)), digits=3), c("",
        "Mean (SD)"=sprintf("%s (%s)", MEAN, SD)))
}

table1( ~ age_at_index + member_sex + dx_imputed + risk_score_dx + months_diagnosed + any_bh + bh_if_engaged | spring_dummy,
        overall = F,
        render.continuous = render.cont,
        footnote = "This table is based on raw values. In cases where 2 matches were not achieved, weights were applied.",
        data=df_match_table)


# This is better with p-values but formatting is ugly
library(survey)
library(tableone)
t1_design <- svydesign(ids = ~carrier_member_id, strata = ~spring_dummy, weights = ~weights_nn,
                       nest = TRUE, data = df_match_table)

t1 <- svyCreateTableOne(
  vars = c("age_at_index", "member_sex", "dx_imputed", "risk_score_dx", "months_diagnosed",
           "cc_asthma_copd", "cc_diabetes", "cc_hypertension", "cc_cancer", "excl_pregnancy", "any_bh", "bh_if_engaged"), 
  strata = "spring_dummy", 
  data = t1_design) 

t1 %>%
  kableone() %>%
  kable_classic(full_width = FALSE, html_font = "Cambria") %>%
  remove_column(5) 

print(t1, pDigits=5, catDigits=3, contDigits=3) 
p.adjust(c(.9552, .18473, 1.000, 0.99969, .00103, 0.83596, 0.74330, .00001, .02078, 0.15857, .00001, .00001), method="BH")
```

  
# Primary outcome - Medical spending

## Medical spend models
Below are the results of the total cost of care study across the entire population and the matched group only.
``` {r net-spend, fig.width = 9, fig.height = 5}

# Add net
df_matched <- df_matched %>%
  mutate(
    med_pmpm_net = med_pmpm + effective_session_fee * spring_tx_count_month,
    med_pmpm_trunc_net = med_pmpm_trunc + effective_session_fee * spring_tx_count_month,
    med_pmpm_therapy_mh_net = med_pmpm_therapy_mh + effective_session_fee * spring_tx_count_month,
    med_pmpm_trunc_therapy_mh_net = med_pmpm_trunc_therapy_mh + effective_session_fee * spring_tx_count_month
  )

# Aggregate to mental and physical health spend
df_matched <- df_matched %>%
  mutate(
    med_pmpm_trunc_mh_net = 
      med_pmpm_trunc_therapy_mh_net + 
      med_pmpm_trunc_ov_mh + 
      med_pmpm_trunc_er_mh + 
      med_pmpm_trunc_ip_mh + 
      med_pmpm_trunc_hosp_op_mh + 
      med_pmpm_trunc_other_mh,
    med_pmpm_trunc_nonmh = 
      med_pmpm_trunc_therapy_nonmh + 
      med_pmpm_trunc_ov_nonmh + 
      med_pmpm_trunc_er_nonmh + 
      med_pmpm_trunc_ip_nonmh + 
      med_pmpm_trunc_hosp_op_nonmh + 
      med_pmpm_trunc_other_nonmh
  )

# Let's recode customer so the intercept reflects the average across participants
cust_recode <- df_matched %>%
  group_by(customer_name) %>%
  summarize(cust_row_count = n()) %>%
  ungroup() %>%
  mutate(cust_prop = cust_row_count/sum(cust_row_count)) %>%
  select(customer_name, cust_prop) %>%
  pivot_wider(names_from = customer_name, values_from = cust_prop) 

df_matched <- df_matched %>%
  mutate(
    Hearst = ifelse(customer_name == "Hearst", 1, 0),
    Pepsi = ifelse(customer_name == "Pepsi", 1, 0),
    Tegna = ifelse(customer_name == "Tegna", 1, 0),
    Wellstar = ifelse(customer_name == "Wellstar", 1, 0),
    DocuSign = ifelse(customer_name == "DocuSign", 1, 0)
  )

df_analyze_all <- df_analyze_all %>%
  mutate(
    Hearst = ifelse(customer_name == "Hearst", 1, 0),
    Pepsi = ifelse(customer_name == "Pepsi", 1, 0),
    Tegna = ifelse(customer_name == "Tegna", 1, 0),
    Wellstar = ifelse(customer_name == "Wellstar", 1, 0),
    DocuSign = ifelse(customer_name == "DocuSign", 1, 0)
  )


## Gross
m1_net_no_match <- lmer(med_pmpm_trunc_net ~ 1 + spring_dummy + spring_dummy*phase + Hearst + DocuSign + Tegna + Wellstar +
             (1 | carrier_member_id),
           data = filter(df_analyze_all, index_date >= spring_start_date))

m1_net <- lmer(med_pmpm_trunc_net ~ 1 + spring_dummy + spring_dummy*phase + Hearst + DocuSign + Tegna + Wellstar +
             (1 | carrier_member_id) +
             (1 | subclass_nn),
           weights = weights_nn,
           data = df_matched)

m1_mh <- lmer(med_pmpm_trunc_mh_net ~ 1 + spring_dummy + spring_dummy*phase + Hearst + DocuSign + Tegna + Wellstar +
             (1 | carrier_member_id) +
             (1 | subclass_nn),
           weights = weights_nn,
           data = df_matched)

m1_nonmh <- lmer(med_pmpm_trunc_nonmh ~ 1 + spring_dummy + spring_dummy*phase + Hearst + DocuSign + Tegna + Wellstar +
             (1 | carrier_member_id) +
             (1 | subclass_nn),
           weights = weights_nn,
           data = df_matched)

# Sensitivity
tab_model(m1_net_no_match, m1_net, m1_mh, m1_nonmh,
          show.ci=F, 
          show.se=T, 
          pred.labels = c("Baseline PMPM", "Baseline difference (Spring - Control)", "Control pre-post change", "Hearst", "DocuSign", "Tegna", "Wellstar", "Diff-in-diff (Spring change - Control change)"),
          dv.labels = c("Unmatched", "Matched", "Mental Health Spend", "Physical Health Spend"),
          title = "Spring effect on gross medical spending")


# raw with bootstrapped SEs. 
# Use residuals because we trust the shape of the regression (all binary) but not the noise

#set.seed(8102018)
#numCores <- 5
#cl <- makeCluster(numCores, type = "PSOCK") # make a socket cluster
#doParallel::registerDoParallel(cl)          # how the CPU knows to run in parallel
#
## 5000 total resamples
#m1_boot <- foreach(B = rep(1000, 5), 
#                       .combine = combine_lmeresamp,
#                       .packages = c("lmeresampler", "lme4")) %dopar% {
#                         bootstrap(m1_gross_yes_match, .f = fixef, type = "residual", B = B)
#                       }
#stopCluster(cl)
#
#
#m1_boot$stats %>%
#  data.frame() %>%
#  mutate(
#    lb_95 = observed - 1.96*se,
#    ub_95 = observed + 1.96*se
#  ) %>%
#  mutate(across(observed:ub_95, ~round(.x, 2))) %>%
#  select(-c(rep.mean, bias)) %>%
#  kableone() %>%
#  kable_classic(full_width = FALSE, html_font = "Cambria")
```


## Plot medical spend
``` {r plot-med-spending-results, fig.width = 6, fig.height = 4}
df_plot <- df_matched %>%
  ungroup() %>%
  distinct(spring_dummy, phase) %>%
  cbind(cust_recode) %>%
  mutate(
    phase_label = case_when(
      phase == "pre_tx" ~ "Before MH diagnosis",
      phase == "post_tx" ~ "After MH diagnosis"
    )
  ) %>%
  mutate(phase_label = factor(phase_label, levels = c("Before MH diagnosis", "After MH diagnosis")))

df_plot_total <- predictions(m1_net, newdata = df_plot, re.form = ~0)
df_plot_mh <- predictions(m1_mh, newdata = df_plot, re.form = ~0) 
df_plot_nonmh <- predictions(m1_nonmh, newdata = df_plot, re.form = ~0)

color_scheme <- c('#c7c7c7', "#37837c")

# Overall with error bars
ggplot(df_plot_total, aes(x=phase_label, y=estimate, ymin=conf.low, ymax=conf.high, group = spring_dummy, color = spring_dummy)) +
  geom_errorbar(width = 0.05) +
  geom_point(size=3) +
  geom_line() +
  scale_color_manual(values = color_scheme, labels = c("Control", "Program")) +
  geom_text_repel(aes(label=round(estimate, 0)), hjust = ifelse(df_plot$phase_label == "Before MH diagnosis", 1.4, -0.4)) +
  theme_modern() +
  theme(legend.position = "bottom") +
  labs(
    title = "Spend trajectories for Spring Health versus control group",
    x = "",
    y = "PMPM allowed amount",
    color = ""
  )


```
  
  
## Pharmacy spend models
``` {r model-rx-spend, fig.width = 9, fig.height = 5}

# Only run rx models if client has rx data
## No matching
m1_rx_no_match <- lmer(rx_pmpm_trunc ~ 1 + spring_dummy + spring_dummy*phase + customer_name +
             (1 | carrier_member_id),
           data = filter(df_analyze_all, index_date >= spring_start_date))

## Matching
m1_rx_yes_match <- lmer(rx_pmpm_trunc ~ 1 + spring_dummy + spring_dummy*phase + customer_name +
             (1 | carrier_member_id) +
             (1 | subclass_nn),
           weights = weights_nn,
           data = df_matched)

tab_model(m1_rx_no_match, m1_rx_yes_match, show.ci=F, show.se=T, 
          pred.labels = c("Baseline PMPM", "Baseline difference (Spring - Control)", "Control pre-post change", "Diff-in-diff (Spring change - Control change)"),
          dv.labels = c("Umatched", "Matched"),
          title = "Spring effect on gross pharmacy spending")

# Sensitivity: heavy truncation
df_matched <- df_matched %>%
  mutate(
     rx_pmpm_trunc10k = ifelse(rx_pmpm_trunc > 10000, 10000, rx_pmpm_trunc),
     rx_pmpm_trunc5k = ifelse(rx_pmpm_trunc > 5000, 5000, rx_pmpm_trunc),
     rx_pmpm_trunc2.5k = ifelse(rx_pmpm_trunc > 2500, 2500, rx_pmpm_trunc)
    )

m1_rx_truncate10k <- lmer(rx_pmpm_trunc10k ~ 1 + spring_dummy + spring_dummy*phase + customer_name +
             (1 | carrier_member_id) +
             (1 | subclass_nn),
           weights = weights_nn,
           data = df_matched)

m1_rx_truncate5k <- lmer(rx_pmpm_trunc5k ~ 1 + spring_dummy + spring_dummy*phase + customer_name +
             (1 | carrier_member_id) +
             (1 | subclass_nn),
           weights = weights_nn,
           data = df_matched)

m1_rx_truncate2.5k <- lmer(rx_pmpm_trunc2.5k ~ 1 + spring_dummy + spring_dummy*phase + customer_name +
             (1 | carrier_member_id) +
             (1 | subclass_nn),
           weights = weights_nn,
           data = df_matched)

tab_model(m1_rx_yes_match, m1_rx_truncate10k, m1_rx_truncate5k, m1_rx_truncate2.5k, show.ci=F, show.se=T, 
          pred.labels = c("Baseline PMPM", "Baseline difference (Spring - Control)", "Control pre-post change", "Hearst", "DocuSign", "Tegna", "Wellstar", "Diff-in-diff (Spring change - Control change)"),
          dv.labels = c("Matched - Standard truncation", "Any baseline pharm spend", "Truncate 10k", "Truncate 5k", "Truncate 2.5k"),
          title = "Spring effect on gross pharmacy spending")

```


# High cost conditions

## High cost conditions models
``` {r chronic-condition-modeling}

df_matched <- df_matched %>%
  mutate(cc_any = case_when(
    cc_any == "yes" ~ "yes",
    excl_pregnancy == "yes" ~ "yes",
    TRUE ~ cc_any
  ))


## Model
hcc1 <- lmer(med_pmpm_trunc_net ~ 1 + spring_dummy + spring_dummy*phase + 
             cc_any + cc_any*(spring_dummy + spring_dummy*phase) +
             customer_name +
             (1 | carrier_member_id) +
             (1 | subclass_nn),
           weights = weights_nn,
           data = filter(df_matched, cc_any == "no" | cc_diabetes == "yes"))

hcc2 <- lmer(med_pmpm_trunc_net ~ 1 + spring_dummy + spring_dummy*phase + 
             cc_any + cc_any*(spring_dummy + spring_dummy*phase) +
             customer_name +
             (1 | carrier_member_id) +
             (1 | subclass_nn),
           weights = weights_nn,
           data = filter(df_matched, cc_any == "no" | cc_hypertension == "yes"))

hcc3 <- lmer(med_pmpm_trunc_net ~ 1 + spring_dummy + spring_dummy*phase + 
             cc_any + cc_any*(spring_dummy + spring_dummy*phase) +
             customer_name +
             (1 | carrier_member_id) +
             (1 | subclass_nn),
           weights = weights_nn,
           data = filter(df_matched, cc_any == "no" | cc_asthma_copd == "yes"))

hcc4 <- lmer(med_pmpm_trunc_net ~ 1 + spring_dummy + spring_dummy*phase + 
             cc_any + cc_any*(spring_dummy + spring_dummy*phase) +
             customer_name +
             (1 | carrier_member_id) +
             (1 | subclass_nn),
           weights = weights_nn,
           data = filter(df_matched, cc_any == "no" | excl_pregnancy == "yes"))

hcc5 <- lmer(med_pmpm_trunc_net ~ 1 + spring_dummy + spring_dummy*phase + 
             cc_any + cc_any*(spring_dummy + spring_dummy*phase) +
             customer_name +
             (1 | carrier_member_id) +
             (1 | subclass_nn),
           weights = weights_nn,
           data = filter(df_matched, cc_any == "no" | cc_cancer == "yes"))

m_no_hcc <- lmer(med_pmpm_trunc_net ~ 1 + spring_dummy + spring_dummy*phase + 
             cc_any + cc_any*(spring_dummy + spring_dummy*phase) +
             customer_name +
             (1 | carrier_member_id) +
             (1 | subclass_nn),
           weights = weights_nn,
           data = df_matched)

tab_model(hcc1, hcc2, hcc3, hcc4, hcc5, m_no_hcc,
          dv.labels = c("Diabetes", "Hypertension", "Asthma/COPD", "Pregnancy", "Cancer", "Any HCC"),
          show.ci=F, 
          show.se=T)
```


### Plot by high cost condition
``` {r plot-high-cost-conditions}

# Make plotting df
m_list <- list(hcc1, hcc2, hcc3, hcc4, hcc5)
df_cc_results <- data.frame(
  Term = NA, 
  Estimate = NA, 
  se = NA, 
  z = NA, 
  p = NA, 
  lb = NA, 
  ub = NA)

for (i in 1:length(m_list)) {
  df_cc_results[i,] <- hypotheses(m_list[[i]], hypothesis = "b9 + b12 = 0")
  df_cc_results[length(m_list) + 1,] <- hypotheses(m_no_hcc, hypothesis = "b9 = 0")
}

# Add cc names
df_cc_results <- df_cc_results %>%
  mutate(
    hcc = c("Diabetes", "Hypertension", "Asthma/COPD", "Pregnancy", "Cancer", "No high cost condition"),
    var_name = c("cc_diabetes", "cc_hypertension", "cc_asthma_copd", "excl_pregnancy", "cc_cancer", "No high cost condition")
  )

## Make it nice
df_plot_hcc <- df_cc_results %>%
  mutate(
    Estimate = -1*Estimate,
    lb = -1*lb,
    ub = -1*ub
  ) %>%
  mutate(hcc = fct_reorder(as.factor(hcc), Estimate))


# Make dotplot
ggplot(df_plot_hcc, aes(x=Estimate, xmin=lb, xmax=ub, y=hcc)) +
  geom_pointrange(position = position_dodge(width=0.5)) +
  geom_text(aes(x=Estimate, y=hcc, label = round(Estimate, 0), fill = NULL, vjust = -1), colour = "#8e8e8e", size = 3) +
  geom_segment(x = 0, xend=0, y=1, yend = 6.1, linetype = "dashed", color = "grey") +
  annotate(geom = "text", x=0, y=6.3, label = "Cost offset", hjust=0.5, color = "grey") +
  expand_limits(y = c(1, 6.5)) +
  theme_modern() +
  theme(legend.position = "bottom") +
  labs(
    x = "PMPM savings",
    y = "",
    fill = " "
  )

```


## Service categories
``` {r cost-categories}
# Mental health vs Physical health
m1_mh <- lmer(med_pmpm_trunc_mh ~ 1 + spring_dummy + spring_dummy*phase + Hearst + DocuSign + Tegna + Wellstar +
                (1 | carrier_member_id) +
                (1 | subclass_nn),
              weights = weights_nn,
              data = df_matched)

m1_nonmh <- lmer(med_pmpm_trunc_nonmh ~ 1 + spring_dummy + spring_dummy*phase + Hearst + DocuSign + Tegna + Wellstar +
                   (1 | carrier_member_id) +
                   (1 | subclass_nn),
                 weights = weights_nn,
                 data = df_matched)

# By category

cc1 <- lmer(med_pmpm_trunc_ov_mh ~ 1 + spring_dummy + spring_dummy*phase +
              Hearst + DocuSign + Tegna + Wellstar + 
              (1 | carrier_member_id) +
              (1 | subclass_nn),
            weights = weights_nn,
            data = df_matched)

cc2 <- lmer(med_pmpm_trunc_er_mh ~ 1 + spring_dummy + spring_dummy*phase +
              Hearst + DocuSign + Tegna + Wellstar + 
              (1 | carrier_member_id) +
              (1 | subclass_nn),
            weights = weights_nn,
            data = df_matched)

cc3 <- lmer(med_pmpm_trunc_hosp_op_mh ~ 1 + spring_dummy + spring_dummy*phase +
              Hearst + DocuSign + Tegna + Wellstar + 
              (1 | carrier_member_id) +
              (1 | subclass_nn),
            weights = weights_nn,
            data = df_matched)

cc4 <- lmer(med_pmpm_trunc_ip_mh ~ 1 + spring_dummy + spring_dummy*phase +
              Hearst + DocuSign + Tegna + Wellstar + 
              (1 | carrier_member_id) +
              (1 | subclass_nn),
            weights = weights_nn,
            data = df_matched)

cc5 <- lmer(med_pmpm_trunc_therapy_mh_net ~ 1 + spring_dummy + spring_dummy*phase +
              Hearst + DocuSign + Tegna + Wellstar + 
              (1 | carrier_member_id) +
              (1 | subclass_nn),
            weights = weights_nn,
            data = df_matched)

## Non-MH
cc6 <- lmer(med_pmpm_trunc_ov_nonmh ~ 1 + spring_dummy + spring_dummy*phase +
              Hearst + DocuSign + Tegna + Wellstar + 
              (1 | carrier_member_id) +
              (1 | subclass_nn),
            weights = weights_nn,
            data = df_matched)

cc7 <- lmer(med_pmpm_trunc_er_nonmh ~ 1 + spring_dummy + spring_dummy*phase +
              Hearst + DocuSign + Tegna + Wellstar + 
              (1 | carrier_member_id) +
              (1 | subclass_nn),
            weights = weights_nn,
            data = df_matched)

cc8 <- lmer(med_pmpm_trunc_hosp_op_nonmh ~ 1 + spring_dummy + spring_dummy*phase +
              Hearst + DocuSign + Tegna + Wellstar + 
              (1 | carrier_member_id) +
              (1 | subclass_nn),
            weights = weights_nn,
            data = df_matched)

cc9 <- lmer(med_pmpm_trunc_ip_nonmh ~ 1 + spring_dummy + spring_dummy*phase +
              Hearst + DocuSign + Tegna + Wellstar + 
              (1 | carrier_member_id) +
              (1 | subclass_nn),
            weights = weights_nn,
            data = df_matched)

cc10 <- lmer(med_pmpm_trunc_therapy_nonmh ~ 1 + spring_dummy + spring_dummy*phase +
               Hearst + DocuSign + Tegna + Wellstar + 
               (1 | carrier_member_id) +
               (1 | subclass_nn),
             weights = weights_nn,
             data = df_matched)

spend_cat <- rep(c("Office visits", "Emergency room", "Hospital outpatient", "Hospital inpatient", "Behavioral Health"), 2)
mh_spend <- c(rep("Mental health", 5), rep("Physical health", 5))
df_cc_list <- list()

for (i in 1:10) {
  df_temp <- predictions(get(paste0("cc", i)), newdata = df_plot, re.form = ~0) %>%
    mutate(
      spend_category = spend_cat[i],
      mh = mh_spend[i]
      )
  df_cc_list[[i]] <- df_temp
}
```


``` {r service-category-figures, fig.width = 12, fig.height = 9}
df_cc_plot <- df_cc_list %>%
  bind_rows() %>%
  filter(phase == "post_tx") %>%
  mutate(across(c(estimate, conf.low, conf.high), 
                ~ ifelse(spring_dummy == "Spring" & spend_category == "Behavioral Health" & mh == "Mental health", .x + spring_cost_adjustment, .x))) %>% 
  select(spring_dummy, spend_category, mh, estimate, conf.low, conf.high) %>%
  mutate(spring_dummy = factor(spring_dummy, levels = c("Health Plan", "Spring"))) %>%
  mutate(spend_category = factor(spend_category, levels = c("Office visits", "Emergency room", "Hospital outpatient", "Hospital inpatient", "Behavioral Health")))


# Aesthetics
y_total <- 650 # total axis scale
y_cat <- 275 # category axis scale
cc_colors <- c("#34a853", "grey")

# Overall MH
df_plot_mh <- predictions(m1_mh, newdata = df_plot, re.form = ~0) %>%
  mutate(spend_category = "Mental Health - Overall") %>%
  filter(phase == "post_tx") %>%
  mutate(spring_dummy = ifelse(spring_dummy == "Spring", "Program", "Control"))

p1 <- ggplot(df_plot_mh, aes(x=spring_dummy, y=estimate, ymin = conf.low, ymax = conf.high, fill = spring_dummy, group = spring_dummy)) +
  geom_bar(stat = "identity", width = 0.5) +
  geom_errorbar(width = .1, color = "gray45") +
  scale_fill_manual(values = rev(cc_colors), labels = c("Control", "Program")) +
  geom_text(aes(x=spring_dummy, y=conf.high, label = round(estimate, 0), fill = NULL), colour = "gray35", size = 4, vjust=-0.3) +
  scale_y_continuous(breaks = seq(0, y_total, by = 200), limits = c(0, y_total)) +
  theme_modern() +
  theme(panel.grid.major.y = element_line(color = "gray85")) +
  theme(axis.text.x = element_text(size=15)) +
  theme(axis.text.y = element_text(size=15)) +
  theme(axis.title.x = element_text(size=18)) +
  theme(legend.text =  element_text(size=14)) +
  theme(
    legend.position = "none",
    legend.justification = "right",
    strip.text = element_text(size=15)
  ) +
  labs(
    title = "Mental Health Costs - Overall",
    x = "",
    y = "PMPM spend",
    fill = " "
  )
fig_legend <- get_legend(p1 + theme(legend.position = "bottom"))

# Overall PH
df_plot_nonmh <- predictions(m1_nonmh, newdata = df_plot, re.form = ~0) %>%
  filter(phase == "post_tx") %>%
  mutate(spend_category = "Physical Health - Overall") %>%
  mutate(spring_dummy = ifelse(spring_dummy == "Spring", "Program", "Control"))

p2 <- ggplot(df_plot_nonmh, aes(x=spring_dummy, y=estimate, ymin = conf.low, ymax = conf.high, fill = spring_dummy, group = spring_dummy)) +
  geom_bar(stat = "identity", width = 0.5) +
  geom_errorbar(width = .1, color = "gray45") +
  scale_fill_manual(values = rev(cc_colors), labels = c("Control", "Program")) +
  geom_text(aes(x=spring_dummy, y=conf.high, label = round(estimate, 0), fill = NULL), colour = "gray35", size = 4, vjust=-0.3) +
  scale_y_continuous(breaks = seq(0, y_total, by = 200), limits = c(0, y_total)) +
  theme_modern() +
  theme(panel.grid.major.y = element_line(color = "gray85")) +
  theme(axis.text.x = element_text(size=15)) +
  theme(axis.text.y = element_text(size=15)) +
  theme(axis.title.x = element_text(size=18)) +
  theme(legend.text =  element_text(size=14)) +
  theme(
    legend.position = "none",
    legend.justification = "right",
    strip.text = element_text(size=15)
  ) +
  labs(
    title = "Physical Health Costs - Overall",
    x = "",
    y = "PMPM spend",
    fill = " "
  )


# MH breakdown
p3 <- ggplot(filter(df_cc_plot, mh == "Mental health"), aes(x=spend_category, y=estimate, ymin = conf.low, ymax = conf.high, fill = spring_dummy, group = spring_dummy)) +
  geom_bar(stat = "identity", width = 0.6, position = position_dodge()) +
  geom_errorbar(position = position_dodge(0.6), width = .1, color = "gray45") +
  scale_fill_manual(values = rev(cc_colors), labels = c("Control", "Program")) +
  geom_text(aes(x=spend_category, y=conf.high, label = round(estimate, 0), fill = NULL), colour = "gray35", size = 4, vjust=-0.3, position = position_dodge(width = 0.6)) +
  scale_x_discrete(labels = scales::label_wrap(10)) +
  scale_y_continuous(breaks = seq(0, y_cat, by = 100), limits = c(-20, 275)) +
  theme_modern() +
  theme(panel.grid.major.y = element_line(color = "gray85")) +
  theme(axis.text.x = element_text(size=15)) +
  theme(axis.text.y = element_text(size=15)) +
  theme(axis.title.x = element_text(size=18)) +
  theme(legend.text =  element_text(size=14)) +
  theme(
    legend.position = "none",
    legend.justification = "right",
    strip.text = element_text(size=15)
  ) +
  labs(
    title = "Mental Health Costs by Service Category",
    x = "",
    y = "PMPM spend",
    fill = " "
  )


# PH breakdown
p4 <- ggplot(filter(df_cc_plot, mh == "Physical health" & spend_category != "Behavioral Health"), aes(x=spend_category, y=estimate, ymin = conf.low, ymax = conf.high, fill = spring_dummy, group = spring_dummy)) +
  geom_bar(stat = "identity", width = 0.6, position = position_dodge()) +
  geom_errorbar(position = position_dodge(0.6), width = .1, color = "gray45") +
  scale_fill_manual(values = rev(cc_colors), labels = c("Control", "Program")) +
  geom_text(aes(x=spend_category, y=conf.high, label = round(estimate, 0), fill = NULL), colour = "gray35", size = 4, vjust=-0.3, position = position_dodge(width = 0.6)) +
  scale_x_discrete(labels = scales::label_wrap(10)) +
  scale_y_continuous(breaks = seq(0, y_cat, by = 100), limits = c(-20, 275)) +
  theme_modern() +
  theme(panel.grid.major.y = element_line(color = "gray85")) +
  theme(axis.text.x = element_text(size=15)) +
  theme(axis.text.y = element_text(size=15)) +
  theme(axis.title.x = element_text(size=18)) +
  theme(legend.text =  element_text(size=14)) +
  theme(
    legend.position = "none",
    legend.justification = "right",
    strip.text = element_text(size=15)
  ) +
  labs(
    title = "Physical Health Costs by Service Category",
    x = "",
    y = "PMPM spend",
    fill = " "
  )

cowplot::plot_grid(p1, p2, p3, p4, NA, fig_legend, nrow=3, rel_heights = c(1,1,.07))
```



## Therapy moderators

``` {r therapy-moderators}

# Calculate cumulative sessions
df_matched <- df_matched %>%
  group_by(carrier_member_id) %>%
  arrange(months) %>%
  mutate(
    session_count = case_when(
      spring_dummy == "Spring" ~ cumsum(spring_tx_count_month),
      spring_dummy == "Health Plan" ~ cumsum(carrier_tx_count_month)
    )
  ) %>%
  mutate(session_count_trunc = ifelse(session_count > 24, 24, session_count)) %>%
  mutate(session_count_total = max(session_count, na.rm=T))

# Let's look at non-mh spending only, since otherwise spending is complicated by spring spend not being included 
ggplot(df_matched, aes(x=session_count, y = med_pmpm_trunc_nonmh)) +
  geom_point() +
  geom_smooth() +
  facet_wrap(.~ months_post) +
  theme_modern() +
  ylim(0, 5000)


# Allow some nonlinearity
df_matched <- df_matched %>%
  mutate(
    therapy_sessions_factor = case_when(
      session_count == 0 ~ "0",
      session_count > 0 & session_count <= 2 ~ "1 to 2",
      session_count > 2 & session_count <= 5 ~ "3 to 5",
      session_count > 5 & session_count <= 12 ~ "6 to 12",
      session_count > 12 ~ "13+"
    ),
    any_therapy = ifelse(session_count > 0, "yes", "no")
  ) %>%
  mutate(therapy_sessions_factor = factor(therapy_sessions_factor, levels = c("0", "1 to 2", "3 to 5", "6 to 12", "13+")))

m_sessions0 <- lmer(med_pmpm_trunc_nonmh ~ 0 + spring_dummy:phase + spring_dummy:as.factor(session_count_trunc) + as.factor(months_post):spring_dummy + 
             (1 | carrier_member_id) +
             (1 | subclass_nn),
           weights = weights_nn,
           data = filter(df_matched))

m_sessions_numeric <- lmer(med_pmpm_trunc_nonmh ~ 0 + spring_dummy:phase + spring_dummy:session_count_trunc + as.factor(months_post):spring_dummy + 
             (1 | carrier_member_id) +
             (1 | subclass_nn),
           weights = weights_nn,
           data = filter(df_matched))

df_sessions <- m_sessions0 %>%
  broom.mixed::tidy() %>%
  filter(str_detect(term, "session_count")) %>%
  #mutate(term = str_replace(term, "spring_dummy", "")) %>%
  mutate(group = ifelse(str_detect(term, "Health Plan"), "Control", "Spring")) %>%
  mutate(sessions = str_extract(term,  "\\)(.*)")) %>%
  mutate(sessions = str_replace(sessions, "\\)", "")) %>%
  mutate(sessions = as.numeric(sessions))

ggplot(df_sessions, aes(x=sessions, y=estimate, group=group, color=group)) +
  geom_point() +
  geom_line() +
  geom_hline(yintercept = 0, linetype = "dashed") +
  theme_modern()

m_sessions1 <- lmer(med_pmpm_trunc_nonmh ~ 1 + spring_dummy + spring_dummy*phase + Hearst + Pepsi + Tegna + Wellstar +
                     as.factor(months_post) + as.factor(months_post)*spring_dummy + 
                      any_therapy + session_count + session_count*spring_dummy + 
             (1 | carrier_member_id) +
             (1 | subclass_nn),
           weights = weights_nn,
           data = df_matched)

m_sessions2 <- lmer(med_pmpm_trunc_nonmh ~ 1 + spring_dummy + spring_dummy*phase + Hearst + Pepsi + Tegna + Wellstar +
                     as.factor(months_post) + as.factor(months_post)*spring_dummy + 
                      therapy_sessions_factor + therapy_sessions_factor*spring_dummy + 
             (1 | carrier_member_id) +
             (1 | subclass_nn),
           weights = weights_nn,
           data = df_matched)

m_sessions3 <- lmer(med_pmpm_trunc_nonmh ~ 1 + spring_dummy + spring_dummy*phase + Hearst + Pepsi + Tegna + Wellstar +
                     as.factor(months_post) + as.factor(months_post)*spring_dummy + 
                      therapy_sessions_factor + 
             (1 | carrier_member_id) +
             (1 | subclass_nn),
           weights = weights_nn,
           data = df_matched)

tab_model(m_sessions1, m_sessions2,
          drop = c("Hearst", "Pepsi", "Tegna", "Wellstar", "months_post", "(Intercept)", "phase"), 
          show.ci=F,
          show.icc = F,
          show.re.var = F,
          show.r2 = F,
          show.aic = T,
          dv.labels = c("Model 1", "Model 2"), 
          show.se=T)

```

## Trajectories

``` {r trajectory-splines}
library(splines)

# Fit models
m1_spline <- lmer(med_pmpm_trunc_net ~ 1 + spring_dummy + spring_dummy*phase +
                    spring_dummy*(ns(months_post, df = 4)) +
                    (1 | carrier_member_id) +
                    (1 | subclass_nn),
                  weights = weights_nn,
                  data = df_matched)

df_pred <- df_matched %>%
  distinct(spring_dummy, phase, months, months_post)

  df_plot_splines <- predictions(
    m1_spline,
    newdata = df_pred,
    re.form = ~0)
 

# Plot raw
df_matched %>%
  group_by(spring_dummy, months) %>%
  summarize(
    pmpm = mean(med_pmpm_trunc_net, na.rm=T),
    sd = sd(med_pmpm_trunc, na.rm=T),
    n = n_distinct(carrier_member_id),
    se = sd/sqrt(n)
    ) %>%
  filter(months <= 12) %>%
  ggplot(., aes(x=months, y=pmpm, ymin = pmpm - 1.96*se, ymax = pmpm + 1.96*se, group = spring_dummy, color=spring_dummy)) +
  geom_vline(xintercept = 0, linetype = "dotted") +
  geom_pointrange() +
  geom_line() +
  theme_modern() +
  theme(
    legend.position = "none",
    strip.text.x = element_blank()
    ) +
  labs(title = "Net ROI")


## Make it disappear by plotting from launch date
## Approximate net ROI
df_matched %>%
  mutate(months_from_launch = interval(spring_start_date, month_year) %/% months(1) + 1) %>%
  group_by(spring_dummy, months_from_launch) %>%
  summarize(
    pmpm = mean(med_pmpm_trunc_net, na.rm=T),
    sd = sd(med_pmpm_trunc, na.rm=T),
    n = n_distinct(carrier_member_id),
    se = sd/sqrt(n)
    ) %>%
  filter(months_from_launch <= 12) %>%
  ggplot(., aes(x=months_from_launch, y=pmpm, ymin = pmpm - 1.96*se, ymax = pmpm + 1.96*se, group = spring_dummy, color=spring_dummy)) +
  geom_vline(xintercept = 0, linetype = "dotted") +
  geom_pointrange() +
  geom_line() +
  scale_color_manual(values = rev(cc_colors), labels = c("Control", "Spring Health")) +
  theme_modern() +
  theme(
    legend.position = "none",
    strip.text.x = element_blank()
    ) +
  labs(
    x = "Months from Spring launch",
    y = "PMPM ($)",
    title = "Make it disappear by plotting from launch date")


# Plot splines
ggplot(df_plot_splines, aes(x=months, y=estimate, ymin = conf.low, ymax=conf.high, group = spring_dummy, color=spring_dummy)) +
  geom_line() +
  geom_pointrange() +
  theme_modern() +
  theme(
    legend.position = "none",
    strip.text.x = element_blank()
  ) +
    labs(title = "Net ROI")

```

``` {r monthly-cc-breakdown, fig.width=7, fig.height=7}

df_monthly_spend <- df_matched %>%
  group_by(spring_dummy, months) %>%
  summarize(
    pmpm_mh_ov = mean(med_pmpm_trunc_ov_mh, na.rm=T),
    pmpm_mh_er = mean(med_pmpm_trunc_er_mh, na.rm=T),
    pmpm_mh_op = mean(med_pmpm_trunc_hosp_op_mh, na.rm=T),
    pmpm_mh_ip = mean(med_pmpm_trunc_ip_mh, na.rm=T),
    pmpm_mh_therapy = mean(med_pmpm_therapy_mh_net),
    
    pmpm_nonmh_ov = mean(med_pmpm_trunc_ov_nonmh, na.rm=T),
    pmpm_nonmh_er = mean(med_pmpm_trunc_er_nonmh, na.rm=T),
    pmpm_nonmh_op = mean(med_pmpm_trunc_hosp_op_nonmh, na.rm=T),
    pmpm_nonmh_ip = mean(med_pmpm_trunc_ip_nonmh, na.rm=T),
    pmpm_nonmh_therapy = mean(med_pmpm_therapy_nonmh)
    ) %>%
  filter(months <= 12) %>%
  filter(months > 0) %>%
  pivot_longer(
    cols = c(pmpm_mh_ov:pmpm_nonmh_therapy),
    names_prefix = "pmpm_",
    names_to = "spend_cat",
    values_to = "estimate"
    ) %>%
  mutate(
    mh_spend = ifelse(str_starts(spend_cat, "mh_*"), "mh", "non-MH"),
    category = str_replace(spend_cat, ".*_", "")
  ) %>%
  mutate(
    mh_spend = ifelse(mh_spend == "mh", "Mental Health spend", "Non-MH spend"),
    category = case_when(
      category == "er" ~ "ER",
      category == "ip" ~ "Inpatient",
      category == "op" ~ "Outpatient",
      category == "ov" ~ "Office Visits",
      category == "therapy" ~ "Therapy"
    )
  ) %>%
  mutate(category = factor(category, levels = c("Therapy", "Office Visits", "ER", "Inpatient", "Outpatient")))

# Category level
ggplot(filter(df_monthly_spend, category != "Therapy"), aes(x=months, y=estimate, group = spring_dummy, fill = spring_dummy)) +
  geom_bar(stat = "identity", width = 0.6, position=position_dodge()) +
  scale_fill_manual(values = rev(cc_colors)) +
  #geom_text(aes(x=total, y=chronic_condition, label = round(total, 0), fill = NULL, hjust = ifelse(total < 0, 1.1, -0.4)), colour = "#8e8e8e", size = 3, data = df_labels) +
  #expand_limits(x=c(0, 1.1*max(df_labels$total))) +
  theme_modern() +
  facet_grid(rows=vars(category), cols=vars(mh_spend), scales = "fixed") +
  theme(legend.position = "bottom") +
  theme(strip.text = element_text(size = 14)) +
  labs(
    title = "Monthly spend by service category",
    x = "Months after Spring launch",
    y = "PMPM savings",
    fill = " "
  )

# MH vs non-MH
df_monthly_spend %>%
  group_by(spring_dummy, months, mh_spend) %>%
  summarize(estimate = sum(estimate, na.rm=T)) %>%
  # Plot
  ggplot(., aes(x=months, y=estimate, group = spring_dummy, fill = spring_dummy)) +
  geom_bar(stat = "identity", width = 0.6, position=position_dodge()) +
  scale_fill_manual(values = rev(cc_colors)) +
  #geom_text(aes(x=total, y=chronic_condition, label = round(total, 0), fill = NULL, hjust = ifelse(total < 0, 1.1, -0.4)), colour = "#8e8e8e", size = 3, data = df_labels) +
  #expand_limits(x=c(0, 1.1*max(df_labels$total))) +
  theme_modern() +
  facet_grid(rows=vars(mh_spend), scales = "fixed") +
  theme(legend.position = "bottom") +
  theme(strip.text = element_text(size = 14)) +
  labs(
    title = "Monthly spend for mental health and non-mental health conditions",
    x = "Months after Spring launch",
    y = "PMPM savings",
    fill = " "
  )

```

# ROI

## Calculate ROI
* Note: participant-year ROI multiple is too high because it is currently based on incomplete fees.
``` {r calculate-roi}
df_roi <- df_matched %>%
  filter(spring_dummy == "Spring") %>%
  filter(month_year == first_spring_tx_date) %>%
  mutate(months_treated = interval(first_spring_tx_date, spring_end_date) %/% months(1) + 1) %>%
  group_by(months_treated) %>%
  summarize(n = n_distinct(carrier_member_id)) %>%
  mutate(
    member_months_treated = n*months_treated,
    month_roi_gross = -1*n*months_treated*summary(m1_gross_yes_match)$coefficients["spring_dummySpring:phasepost_tx", 1])
mean_months_treated <- sum(df_roi$member_months_treated)/sum(df_roi$n)


# First program year gross savings %
deltamethod(m1_gross_yes_match, "0 = (6.5*b8) / ((12-6.5)*df_plot$estimate[1] + 6.5*(df_plot$estimate[2]))")

# First Program-year PMPY
deltamethod(m1_gross_yes_match, "0 = -1 * b8 * mean_months_treated")

# Program-year ROI multiple
deltamethod(m1_gross_yes_match, "0 = (b8*(sum(df_roi$member_months_treated)))/total_invoiced")
deltamethod(m1_gross_yes_match, "1 = ((b8 + spring_pmpm_adjustment)*(sum(df_roi$member_months_treated))/total_invoiced)")

# Participant year gross savings %
deltamethod(m1_gross_yes_match, "0 = b8 / (df_plot$estimate[1] + df_plot$estimate[2])")

# Participant year PMPY ($)
deltamethod(m1_gross_yes_match, "0 = 12*b8")

# Participant-year ROI multiple
deltamethod(m1_gross_yes_match, "0 = (-1*b8*12*sum(df_roi$n))/total_invoiced")
```


# Sensitivity analysis

## Do session counts differ for individuals with high cost conditoins?
``` {r cc-session-counts}
df_cc_table <- df_match_table %>%
  mutate(cc_group = case_when(
    cc_cancer == "yes" ~ "Cancer",
    cc_hypertension == "yes" ~ "Hypertension",
    excl_pregnancy == "yes" ~ "Pregnancy",
    cc_diabetes == "yes" ~ "Diabetes",
    cc_asthma_copd == "yes" ~ "Asthma/COPD",
    TRUE ~ "No chronic condition"
  )) 

table1( ~ age_at_index + member_sex + dx_imputed + risk_score_dx + months_diagnosed + any_bh + bh_if_engaged | spring_dummy*cc_group,
        overall = T,
        footnote = "This table is based on raw values. In cases where 2 matches were not achieved, weights were applied.",
        data=df_cc_table)
```

## Participant-year trajectories
``` {r participant-year-trajectories}

m_1yr_participant <- lmer(med_pmpm_trunc ~ 1 + spring_dummy + as.factor(months_post) +
                          spring_dummy*as.factor(months_post) + 
                             (1 | carrier_member_id) +
                             (1 | subclass_nn),
                           weights = weights_nn,
                           data = df_matched)

tab_model(m_1yr_participant, show.ci=F, show.se=T)

# Get PPPY in dollars
hypotheses(m_1yr_participant, hypothesis = "b15 + b16 + b17 + b18 + b19 + b20 + b21 + b22 + b23 + b24 + b25 + b26 = 0")

# Get PPPY in pct
hypotheses(m_1yr_participant, hypothesis = "(b15 + b16 + b17 + b18 + b19 + b20 + b21 + b22 + b23 + b24 + b25 + b26) /
          (b1*12 + b3 + b4 + b5 + b6 + b7 + b8 + b9 + b10 + b11 + b12 + b13 + b14)  = 0")

# Plot
df_plot_participant_year <- df_matched %>%
  ungroup() %>%
  distinct(spring_dummy, months, months_post) 

df_plot_participant_year <- predictions(m_1yr_participant, newdata = df_plot_participant_year,  re.form = ~0)
monthly_avg_did <- pull(hypotheses(m_1yr_participant, hypothesis = "b15 + b16 + b17 + b18 + b19 + b20 + b21 + b22 + b23 + b24 + b25 + b26 = 0")[2]/12)

# Overall with error bars
ggplot(df_plot_participant_year, aes(x=months, y=estimate, ymin=conf.low, ymax=conf.high, group = spring_dummy, color = spring_dummy)) +
  geom_errorbar(width = 0.25) +
  geom_point(size=3) +
  geom_line() +
  scale_color_manual(values = color_scheme, labels = c("Control", "Spring Health")) +
  annotate(geom = "text", x=7, y=1200, label = paste0("Savings = $", round(-1*monthly_avg_did, 0), " PMPM"), color = "#37837c", fontface = "bold") +
  theme_modern() +
  theme(legend.position = "bottom") +
  labs(
    title = "Spend trajectories for Spring Health versus control group",
    x = "",
    y = "PMPM allowed amount",
    color = ""
  )

```


## Stratification by BH treatment
Do we get more savings versus the control group that did not engage in BH treatment? No. 

We have more net savings on mental health spend compared to the control group members that engaged in MH care. Physical health savings are the same in both groups. Don't love that finding as it undermines the narrative the MH treatment provides physical health savings. 

Based on sessions alone, I think we can make the argument that we have more efficient care than the control group, which dovetails with what Dan Harrah was saying about Lyra's length of care in our ROI narrative meeting. We have already shown that we get gold standard clinical outcomes due to MBC, so we can argue that at Spring people get the right amount of care and aren't trapped in therapy endlessly after they don't need it. But I worry that Lyra could make the argument that 4 sessions is not a full course of care and we aren't delivering the care our patients need. Not sure how much to worry about what Lyra would say, though.

``` {r sensitivity}

# Make 3 groups
df_match_table <- df_match_table %>%
  mutate(spring_dummy_stratified = case_when(
    spring_dummy == "Control" & any_bh == "no" ~ "Control, no BH appt",
    spring_dummy == "Control" & any_bh == "yes" ~ "Control group with BH appt",
    spring_dummy == "Spring Health" ~ "Spring Health"
  ))
  
table1( ~ any_bh + session_count_total | spring_dummy_stratified,
        overall = F,
        render.continuous = render.cont,
        footnote = "This table is based on raw values. In cases where 2 matches were not achieved, weights were applied.",
        data=df_match_table)

# Group by BH usage
df_matched <- df_matched %>%
  group_by(carrier_member_id) %>%
  arrange(months) %>%
  mutate(
    therapy_sessions_total = sum(spring_therapist_count_month, carrier_therapist_count_month, na.rm=T),
    session_count_total = sum(spring_tx_count_month, carrier_tx_count_month, na.rm=T)
  ) %>%
  mutate(any_bh = ifelse(session_count_total > 0, "yes", "no")) %>%
  mutate(spring_dummy_stratified = case_when(
    spring_dummy == "Health Plan" & any_bh == "no" ~ "Control, no BH appt",
    spring_dummy == "Health Plan" & any_bh == "yes" ~ "Control, yes BH appt",
    spring_dummy == "Spring" ~ "Spring Health"
  )) %>%
  mutate(spring_dummy_stratified = factor(spring_dummy_stratified, levels = c("Spring Health", "Control, no BH appt", "Control, yes BH appt")))

df_matched <- df_matched %>%
  mutate(session_count_trunc = ifelse(session_count_total > 24, 24, session_count_total))


m1_bh_overall <- lmer(med_pmpm_trunc_net ~ 1 + spring_dummy_stratified + spring_dummy_stratified:phase +
             (1 | carrier_member_id) +
             (1 | subclass_nn),
           weights = weights_nn,
           data = df_matched)
  
m1_bh_mh_spend <- lmer(med_pmpm_trunc_mh_net ~ 1 + spring_dummy_stratified + spring_dummy_stratified:phase +
             (1 | carrier_member_id) +
             (1 | subclass_nn),
           weights = weights_nn,
           data = df_matched)

m1_bh_nonmh_spend <- lmer(med_pmpm_trunc_nonmh ~ 1 + spring_dummy_stratified + spring_dummy_stratified:phase +
             (1 | carrier_member_id) +
             (1 | subclass_nn),
           weights = weights_nn,
           data = df_matched)

tab_model(m1_bh_overall, m1_bh_mh_spend, m1_bh_nonmh_spend,
          show.ci=F, 
          show.se=T,
          pred.labels = c("Baseline Spring PMPM", "Baseline difference (Spring - Control, no BH)", "Baseline difference (Spring - Control, yes BH)", "Spring pre-post change", "Diff-in-diff (Control no BH change - Spring change)", "Diff-in-diff (Control yes BH change - Spring change)"),
          dv.labels = c("Model 1 - Total medical spend", "Model 2 - Mental health spend", "Model 3 - Physical health spend"))
```


## Outcomes by mental health conditions
``` {r -outcomes-by-disorder}

# Models
sud_overall <- lmer(med_pmpm_trunc ~ 1 + spring_dummy + spring_dummy*phase + 
                             (1 | carrier_member_id) +
                             (1 | subclass_nn),
                           #weights = weights_nn,
                           data = filter(df_matched, dx_imputed == "sud"))


mh_mood <- lmer(med_pmpm_trunc_mh ~ 1 + spring_dummy + spring_dummy*phase +
                       (1 | carrier_member_id) +
                       (1 | subclass_nn),
                     weights = weights_nn,
                     data = filter(df_matched, dx_imputed == "mood"))

mh_anxiety <- lmer(med_pmpm_trunc_mh ~ 1 + spring_dummy + spring_dummy*phase + 
                        (1 | carrier_member_id) +
                        (1 | subclass_nn),
                      weights = weights_nn,
                      data = filter(df_matched, dx_imputed == "anxiety"))

mh_sud <- lmer(med_pmpm_trunc_mh ~ 1 + spring_dummy + spring_dummy*phase + 
                             (1 | carrier_member_id) +
                             (1 | subclass_nn),
                           #weights = weights_nn,
                           data = filter(df_matched, dx_imputed == "sud"))

nonmh_mood <- lmer(med_pmpm_trunc_nonmh ~ 1 + spring_dummy + spring_dummy*phase + 
                       (1 | carrier_member_id) +
                       (1 | subclass_nn),
                     weights = weights_nn,
                     data = filter(df_matched, dx_imputed == "mood"))

nonmh_anxiety <- lmer(med_pmpm_trunc_nonmh ~ 1 + spring_dummy + spring_dummy*phase + 
                        (1 | carrier_member_id) +
                        (1 | subclass_nn),
                      weights = weights_nn,
                      data = filter(df_matched, dx_imputed == "anxiety"))

nonmh_sud <- lmer(med_pmpm_trunc_nonmh ~ 1 + spring_dummy + spring_dummy*phase + 
                             (1 | carrier_member_id) +
                             (1 | subclass_nn),
                           #weights = weights_nn,
                           data = filter(df_matched, dx_imputed == "sud"))

dx_list <- list(mh_mood, mh_anxiety, mh_sud, nonmh_mood, nonmh_anxiety, nonmh_sud)

df_dx_results <- data.frame(
  Term = NA, 
  Estimate = NA, 
  se = NA, 
  z = NA, 
  p = NA, 
  lb = NA, 
  ub = NA)

for (i in 1:length(dx_list)) {
  df_dx_results[i,] <- hypotheses(dx_list[[i]], hypothesis = "b4 = 0")
  df_dx_results[7,] <- hypotheses(m_all_mh, hypothesis = "b8 = 0") # add pop average MH
  df_dx_results[8,] <- hypotheses(m_all_nonmh, hypothesis = "b8 = 0") # add pop average non-MH
}

# Add cc names
df_dx_results <- df_dx_results %>%
  mutate(
    mh_diagnosis = c(
      rep(c("Mood", "Anxiety", "SUD"), 2),
      rep("Population average", 2)
      ),
    var_name = c(
      rep(c("mood", "anxiety", "sud"), 2),
      rep("Population average", 2)
    ),
    spend_type = c(rep("Mental healthcare savings", 3), rep("All other healthcare savings", 3), "Mental healthcare savings", "All other healthcare savings")
  )

```


### Plot by MH condition
``` {r plot-dx}

## Make it nice
cc_colors <- c("#34a853", "grey")
df_plot_dx <- df_dx_results %>%
  mutate(
    Estimate = -1*Estimate,
    lb = -1*lb,
    ub = -1*ub
  ) %>%
  mutate(
    mh_diagnosis = fct_reorder(as.factor(mh_diagnosis), Estimate),
    spend_type = fct_relevel(spend_type,"Mental healthcare savings", "All other healthcare savings")
    )

## Let's plot with CIs so we can understand it
ggplot(df_plot_dx, aes(x=Estimate, xmin=lb, xmax=ub, y=mh_diagnosis, color = spend_type)) +
  geom_pointrange(position = position_dodge(width=0.5)) +
  scale_color_manual(values = cc_colors) +
  geom_vline(xintercept = 0, linetype = "dashed") +
  theme_modern() +
  theme(legend.position = "bottom")


## For barplot, we want overall value laels
df_labels <- df_plot_dx %>%
  group_by(mh_diagnosis) %>%
  summarize(total = sum(Estimate)) 


# Bar plot
ggplot(df_plot_dx, aes(x=Estimate, y=mh_diagnosis, fill = spend_type)) +
  geom_bar(stat = "identity", width = 0.6, position=position_stack(reverse=T)) +
  scale_fill_manual(values = cc_colors) +
  geom_text(aes(x=total, y=mh_diagnosis, label = round(total, 0), fill = NULL, hjust = ifelse(total < 0, 1.1, -0.4)), colour = "#8e8e8e", size = 3, data = df_labels) +
  expand_limits(x=c(0, 1.1*max(df_labels$total))) +
  theme_modern() +
  theme(legend.position = "bottom") +
  labs(
    x = "PMPM savings",
    y = "",
    fill = " "
  )


```

## Drop those with month 1 inpatient spend
``` {r drop-inpatient}

df_matched <- df_matched %>%
  group_by(subclass_nn) %>%
  mutate(
    ip_month1 = sum(med_pmpm_trunc_ip_nonmh[months==1], na.rm=T),
    ip_months1_to_3 = sum(med_pmpm_trunc_ip_nonmh[months==1 | months==2 | months==3], na.rm=T)
    ) 

m1_drop_month1_ip <- lmer(med_pmpm_trunc_net ~ 1 + spring_dummy + spring_dummy*phase + Hearst + DocuSign + Tegna + Wellstar +
             (1 | carrier_member_id) +
             (1 | subclass_nn),
           weights = weights_nn,
           data = filter(df_matched, ip_month1==0))

tab_model(m1_net, m1_drop_month1_ip, show.ci=F, show.se=T,
          dv.labels = c("All participants", "Drop participants with month 1 inpatient physical health spend"))
```
